---
phase: 04-sales-agent-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/services/gsuite/__init__.py
  - src/app/services/gsuite/auth.py
  - src/app/services/gsuite/gmail.py
  - src/app/services/gsuite/chat.py
  - src/app/services/gsuite/models.py
  - src/app/config.py
  - pyproject.toml
  - tests/test_gsuite.py
autonomous: true
user_setup:
  - service: google-workspace
    why: "Gmail and Google Chat API access for Sales Agent email/chat capabilities"
    env_vars:
      - name: GOOGLE_SERVICE_ACCOUNT_FILE
        source: "GCP Console -> IAM -> Service Accounts -> Create key (JSON)"
      - name: GOOGLE_DELEGATED_USER_EMAIL
        source: "Google Workspace admin email for domain-wide delegation"
    dashboard_config:
      - task: "Enable Gmail API and Google Chat API in GCP project"
        location: "GCP Console -> APIs & Services -> Library"
      - task: "Configure domain-wide delegation for service account"
        location: "Google Workspace Admin -> Security -> API Controls -> Domain-wide Delegation"

must_haves:
  truths:
    - "Gmail service can compose and send emails with proper MIME encoding and threading"
    - "Gmail service can read email threads for conversation context"
    - "Google Chat service can send messages to spaces with thread support"
    - "All Google API calls are async-wrapped to avoid blocking the event loop"
    - "Service instances are cached per user delegation to avoid repeated credential builds"
  artifacts:
    - path: "src/app/services/gsuite/auth.py"
      provides: "Service account auth with domain-wide delegation and credential caching"
      exports: ["GSuiteAuthManager"]
    - path: "src/app/services/gsuite/gmail.py"
      provides: "Async Gmail API operations (send, read, list threads)"
      exports: ["GmailService"]
    - path: "src/app/services/gsuite/chat.py"
      provides: "Async Google Chat API operations (send message, list spaces)"
      exports: ["ChatService"]
    - path: "src/app/services/gsuite/models.py"
      provides: "Email and chat message Pydantic schemas"
      exports: ["EmailMessage", "EmailThread", "ChatMessage"]
  key_links:
    - from: "src/app/services/gsuite/gmail.py"
      to: "src/app/services/gsuite/auth.py"
      via: "GSuiteAuthManager for delegated credentials"
      pattern: "auth_manager\\.get_gmail_service"
    - from: "src/app/services/gsuite/chat.py"
      to: "src/app/services/gsuite/auth.py"
      via: "GSuiteAuthManager for service account credentials"
      pattern: "auth_manager\\.get_chat_service"
    - from: "src/app/services/gsuite/gmail.py"
      to: "asyncio.to_thread"
      via: "Async wrapping of synchronous Google API calls"
      pattern: "asyncio\\.to_thread"
---

<objective>
Create async GSuite integration services for Gmail and Google Chat APIs, enabling the Sales Agent to send/receive emails and chat messages.

Purpose: SA-02 (Gmail integration) and SA-03 (Google Chat integration) require the agent to communicate via GSuite. This plan creates the foundational service layer that all Sales Agent communication flows through.
Output: GSuiteAuthManager, GmailService, ChatService, and Pydantic message models under src/app/services/gsuite/.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sales-agent-core/04-RESEARCH.md

@src/app/config.py
@src/app/services/llm.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install GSuite dependencies and add config settings</name>
  <files>
    pyproject.toml
    src/app/config.py
  </files>
  <action>
    1. Add to pyproject.toml dependencies:
       - google-api-python-client>=2.0.0
       - google-auth>=2.0.0
       - google-auth-httplib2>=0.2.0
       - google-auth-oauthlib>=1.2.0
       - instructor>=1.7.0
       - jinja2>=3.1.0

    2. Add to Settings in src/app/config.py:
       - GOOGLE_SERVICE_ACCOUNT_FILE: str = "" (path to service account JSON key file)
       - GOOGLE_DELEGATED_USER_EMAIL: str = "" (admin email for domain-wide delegation)
       - GOOGLE_CHAT_SPACE_ID: str = "" (default Google Chat space for internal team notifications)

    3. Run `pip install -e ".[dev]"` (or equivalent) to install new deps.
  </action>
  <verify>
    `python -c "import googleapiclient; import google.auth; import instructor; import jinja2; print('OK')"` prints OK
  </verify>
  <done>All 6 new dependencies installed and importable. Settings class has GOOGLE_SERVICE_ACCOUNT_FILE, GOOGLE_DELEGATED_USER_EMAIL, and GOOGLE_CHAT_SPACE_ID fields.</done>
</task>

<task type="auto">
  <name>Task 2: Create GSuite auth manager, Gmail service, Chat service, and message models</name>
  <files>
    src/app/services/gsuite/__init__.py
    src/app/services/gsuite/auth.py
    src/app/services/gsuite/gmail.py
    src/app/services/gsuite/chat.py
    src/app/services/gsuite/models.py
    tests/test_gsuite.py
  </files>
  <action>
    **src/app/services/gsuite/models.py** - Pydantic schemas:
    - EmailMessage: to (str), subject (str), body_html (str), body_text (str | None), thread_id (str | None), in_reply_to (str | None), cc (list[str] = []), bcc (list[str] = [])
    - EmailThread: thread_id (str), subject (str), messages (list with sender, snippet, date), message_count (int)
    - ChatMessage: space_name (str), text (str), thread_key (str | None = None)
    - SentEmailResult: message_id (str), thread_id (str), label_ids (list[str])
    - SentChatResult: message_name (str), create_time (str)

    **src/app/services/gsuite/auth.py** - GSuiteAuthManager class:
    - __init__(service_account_file: str, delegated_user_email: str) stores config
    - _service_cache: dict[str, Any] for caching built service instances per (api, user_email) tuple
    - _build_credentials(user_email: str | None, scopes: list[str]) -> Credentials: Creates service account credentials, applies with_subject(user_email) if user_email provided
    - get_gmail_service(user_email: str) -> Resource: Returns cached gmail v1 service for the delegated user. Cache key is f"gmail:{user_email}". Uses scopes: gmail.send, gmail.readonly, gmail.modify
    - get_chat_service() -> Resource: Returns cached chat v1 service using service account (no user delegation). Cache key is "chat". Uses scope: chat.bot
    - Pitfall avoidance: Cache service instances per user delegation (Pitfall 1 from research). Do NOT create new build() call per request.

    **src/app/services/gsuite/gmail.py** - GmailService class:
    - __init__(auth_manager: GSuiteAuthManager, default_user_email: str)
    - async send_email(email: EmailMessage) -> SentEmailResult: Wraps Gmail API users().messages().send() with asyncio.to_thread(). Builds RFC 2822 message using stdlib email.message.EmailMessage. Sets In-Reply-To and References headers when in_reply_to is provided (Pitfall 2 from research). Supports HTML body with text fallback.
    - async get_thread(thread_id: str) -> EmailThread: Wraps users().threads().get() with asyncio.to_thread(). Returns structured EmailThread with message summaries.
    - async list_threads(query: str = "", max_results: int = 10) -> list[EmailThread]: Wraps users().threads().list() with asyncio.to_thread(). Supports Gmail search queries (e.g., "from:customer@example.com").
    - All methods use self._auth.get_gmail_service(self._default_user_email) for the service instance.
    - ALL Google API calls MUST be wrapped in asyncio.to_thread() to avoid blocking event loop (Pitfall 7 from research).

    **src/app/services/gsuite/chat.py** - ChatService class:
    - __init__(auth_manager: GSuiteAuthManager)
    - async send_message(message: ChatMessage) -> SentChatResult: Wraps Chat API spaces().messages().create() with asyncio.to_thread(). If thread_key provided, sets messageReplyOption="REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD" and adds thread.threadKey to body.
    - async list_spaces() -> list[dict]: Wraps spaces().list() with asyncio.to_thread(). Returns space names and display names.
    - ALL Google API calls MUST be wrapped in asyncio.to_thread().

    **src/app/services/gsuite/__init__.py** - Exports:
    - Re-export GSuiteAuthManager, GmailService, ChatService, EmailMessage, EmailThread, ChatMessage, SentEmailResult, SentChatResult

    **tests/test_gsuite.py** - Unit tests with mocked Google APIs:
    - Mock google.oauth2.service_account.Credentials and googleapiclient.discovery.build
    - Test GSuiteAuthManager caches services per key (two calls same user -> same object)
    - Test GmailService.send_email builds correct MIME message with headers (In-Reply-To, References, threading)
    - Test GmailService.send_email includes threadId in payload when email.thread_id is set
    - Test ChatService.send_message includes thread key and reply option when thread_key is set
    - Test all public methods use asyncio.to_thread (verify the pattern, can mock to_thread)
    - At least 8 tests covering auth caching, email sending, email threading, chat sending, chat threading, error handling
  </action>
  <verify>
    `python -m pytest tests/test_gsuite.py -v` passes all tests.
    `python -c "from src.app.services.gsuite import GmailService, ChatService, GSuiteAuthManager; print('imports OK')"` succeeds.
  </verify>
  <done>
    GSuiteAuthManager caches service instances per (api, user_email). GmailService sends emails with proper MIME encoding, RFC 2822 threading headers, and HTML support -- all via asyncio.to_thread(). ChatService sends messages to spaces with thread support via asyncio.to_thread(). All tests pass. Models are Pydantic with clear field definitions.
  </done>
</task>

</tasks>

<verification>
1. All GSuite services importable from src.app.services.gsuite
2. Tests pass with mocked Google APIs (no real Google credentials needed)
3. Email MIME encoding handles HTML body, threading headers (In-Reply-To, References), and threadId
4. Chat messages support thread keys and reply fallback option
5. Service instance caching prevents redundant credential builds
6. No synchronous Google API calls on the event loop (all wrapped in asyncio.to_thread)
</verification>

<success_criteria>
- src/app/services/gsuite/ package with auth, gmail, chat, models modules
- GmailService.send_email produces RFC 2822 compliant email with threading support
- ChatService.send_message supports threaded conversations
- All Google API calls async-wrapped via asyncio.to_thread
- GSuiteAuthManager caches service instances per delegation
- 8+ unit tests passing with mocked Google APIs
- New dependencies in pyproject.toml and installable
</success_criteria>

<output>
After completion, create `.planning/phases/04-sales-agent-core/04-01-SUMMARY.md`
</output>
