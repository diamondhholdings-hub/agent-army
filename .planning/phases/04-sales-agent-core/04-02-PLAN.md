---
phase: 04-sales-agent-core
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/agents/sales/__init__.py
  - src/app/agents/sales/schemas.py
  - src/app/agents/sales/prompts.py
autonomous: true

must_haves:
  truths:
    - "BANT and MEDDIC qualification signals can be represented as structured Pydantic models with evidence tracking per field"
    - "Conversation state tracks deal stage, qualification progress, interaction history, and escalation status"
    - "Persona configs produce distinctly different system prompts for IC, manager, and C-suite"
    - "Chris Voss methodology (tactical empathy, mirroring, labeling, calibrated questions) is embedded in all persona prompts"
    - "Email and chat prompts produce channel-appropriate output (email: structured/formal, chat: lighter/shorter)"
  artifacts:
    - path: "src/app/agents/sales/schemas.py"
      provides: "BANT/MEDDIC signal models, ConversationState, DealStage, EscalationReport, PersonaType"
      exports: ["BANTSignals", "MEDDICSignals", "QualificationState", "ConversationState", "DealStage", "PersonaType", "EscalationReport", "NextAction"]
    - path: "src/app/agents/sales/prompts.py"
      provides: "Persona-adapted system prompts for email and chat with Voss methodology"
      exports: ["build_system_prompt", "build_email_prompt", "build_chat_prompt", "build_qualification_extraction_prompt", "PERSONA_CONFIGS"]
  key_links:
    - from: "src/app/agents/sales/prompts.py"
      to: "src/app/agents/sales/schemas.py"
      via: "PersonaType enum used for persona config lookup"
      pattern: "PersonaType"
    - from: "src/app/agents/sales/prompts.py"
      to: "src/knowledge/methodology/"
      via: "References BANT/MEDDIC framework names for methodology prompt sections"
      pattern: "BANT|MEDDIC"
---

<objective>
Define all Pydantic data models for the Sales Agent (qualification signals, conversation state, deal stages, escalation reports) and create the persona-adapted prompt system with Chris Voss methodology.

Purpose: These schemas and prompts are the foundational types that every other Sales Agent component depends on. SA-05 (persona interaction), SA-06 (BANT), SA-07 (MEDDIC), SA-08 (conversation state tracking), and SA-10 (escalation) all require structured data models. The prompt system implements the locked decisions from CONTEXT.md around communication style, tone, and qualification approach.
Output: src/app/agents/sales/schemas.py and src/app/agents/sales/prompts.py -- the types and prompt templates the entire Sales Agent uses.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sales-agent-core/04-CONTEXT.md
@.planning/phases/04-sales-agent-core/04-RESEARCH.md

@src/app/agents/base.py
@src/knowledge/methodology/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sales Agent data models and schemas</name>
  <files>
    src/app/agents/sales/__init__.py
    src/app/agents/sales/schemas.py
  </files>
  <action>
    **src/app/agents/sales/schemas.py** -- All Pydantic models for the Sales Agent domain:

    1. **PersonaType** (str, Enum): IC = "ic", MANAGER = "manager", C_SUITE = "c_suite". Used to select communication style.

    2. **DealStage** (str, Enum): PROSPECTING, DISCOVERY, QUALIFICATION, EVALUATION, NEGOTIATION, CLOSED_WON, CLOSED_LOST, STALLED. Represents the sales pipeline stage.

    3. **Channel** (str, Enum): EMAIL = "email", CHAT = "chat". Communication channel.

    4. **BANTSignals** (BaseModel): Tracks Budget, Authority, Need, Timeline signals with evidence.
       Fields (all optional/defaulted):
       - budget_identified: bool = False
       - budget_range: str | None = None
       - budget_evidence: str | None = None (the actual quote or signal from conversation)
       - budget_confidence: float = Field(default=0.0, ge=0.0, le=1.0)
       - authority_identified: bool = False
       - authority_contact: str | None = None
       - authority_role: str | None = None
       - authority_evidence: str | None = None
       - authority_confidence: float = Field(default=0.0, ge=0.0, le=1.0)
       - need_identified: bool = False
       - need_description: str | None = None
       - need_evidence: str | None = None
       - need_confidence: float = Field(default=0.0, ge=0.0, le=1.0)
       - timeline_identified: bool = False
       - timeline_description: str | None = None
       - timeline_evidence: str | None = None
       - timeline_confidence: float = Field(default=0.0, ge=0.0, le=1.0)
       Property: completion_score -> float: Count of identified fields / 4

    5. **MEDDICSignals** (BaseModel): Tracks Metrics, Economic Buyer, Decision Criteria, Decision Process, Identify Pain, Champion with evidence.
       Fields (all optional/defaulted):
       - metrics_identified: bool = False, metrics_description: str | None, metrics_evidence: str | None, metrics_confidence: float = 0.0
       - economic_buyer_identified: bool = False, economic_buyer_contact: str | None, economic_buyer_evidence: str | None, economic_buyer_confidence: float = 0.0
       - decision_criteria_identified: bool = False, decision_criteria: list[str] = [], decision_criteria_evidence: str | None, decision_criteria_confidence: float = 0.0
       - decision_process_identified: bool = False, decision_process_description: str | None, decision_process_evidence: str | None, decision_process_confidence: float = 0.0
       - pain_identified: bool = False, pain_description: str | None, pain_evidence: str | None, pain_confidence: float = 0.0
       - champion_identified: bool = False, champion_contact: str | None, champion_evidence: str | None, champion_confidence: float = 0.0
       Property: completion_score -> float: Count of identified fields / 6

    6. **QualificationState** (BaseModel): Combined qualification tracking.
       - bant: BANTSignals = Field(default_factory=BANTSignals)
       - meddic: MEDDICSignals = Field(default_factory=MEDDICSignals)
       - overall_confidence: float = Field(default=0.5, ge=0.0, le=1.0)
       - key_insights: list[str] = []
       - recommended_next_questions: list[str] = []
       - last_updated: datetime | None = None
       Property: combined_completion -> float: (bant.completion_score + meddic.completion_score) / 2

    7. **ConversationState** (BaseModel): Full state for a sales conversation/deal.
       - state_id: str (UUID string)
       - tenant_id: str
       - account_id: str
       - contact_id: str
       - contact_email: str
       - contact_name: str = ""
       - deal_stage: DealStage = DealStage.PROSPECTING
       - persona_type: PersonaType = PersonaType.MANAGER
       - qualification: QualificationState = Field(default_factory=QualificationState)
       - interaction_count: int = 0
       - last_interaction: datetime | None = None
       - last_channel: Channel | None = None
       - escalated: bool = False
       - escalation_reason: str | None = None
       - confidence_score: float = 0.5
       - next_actions: list[str] = []
       - follow_up_scheduled: datetime | None = None
       - created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
       - metadata: dict = {}

    8. **EscalationReport** (BaseModel): Structured handoff for human escalation (locked decision from CONTEXT.md).
       - escalation_id: str
       - tenant_id: str
       - account_id: str
       - contact_id: str
       - contact_name: str
       - deal_stage: DealStage
       - escalation_trigger: str (one of: "confidence_low", "high_stakes", "customer_request", "complexity")
       - confidence_score: float
       - account_context: str (summary of account history)
       - what_agent_tried: str (what the agent did before escalating)
       - why_escalating: str (specific reason)
       - recommended_next_action: str
       - relevant_conversation_excerpts: list[str]
       - notification_targets: list[str] (email addresses: [rep_email, manager_email])
       - created_at: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))

    9. **NextAction** (BaseModel): A recommended next action.
       - action_type: str (e.g., "send_email", "send_chat", "schedule_call", "escalate", "wait", "follow_up")
       - description: str
       - priority: str = "medium" (low, medium, high, urgent)
       - suggested_timing: str | None = None (e.g., "within 24 hours", "next business day")
       - context: str = "" (why this action is recommended)

    **src/app/agents/sales/__init__.py** -- Package init, initially just a docstring:
    ```python
    """Sales Agent for text-based sales interactions.

    Provides the SalesAgent (BaseAgent subclass) that conducts sales conversations
    via Gmail and Google Chat, adapting to customer personas, executing BANT/MEDDIC
    qualification, tracking conversation state, and escalating to humans when needed.
    """
    ```
    (Exports will be added in Plan 04 when the agent class exists.)
  </action>
  <verify>
    `python -c "from src.app.agents.sales.schemas import BANTSignals, MEDDICSignals, QualificationState, ConversationState, DealStage, PersonaType, EscalationReport, NextAction, Channel; print('All schemas import OK')"` succeeds.
    `python -c "from src.app.agents.sales.schemas import BANTSignals; b = BANTSignals(budget_identified=True, budget_range='100k-500k'); print(b.completion_score)"` prints 0.25.
    `python -c "from src.app.agents.sales.schemas import ConversationState; s = ConversationState(state_id='test', tenant_id='t1', account_id='a1', contact_id='c1', contact_email='x@y.com'); print(s.deal_stage.value)"` prints "prospecting".
  </verify>
  <done>
    All 9 Pydantic models defined with proper defaults, evidence tracking per qualification field, completion_score properties on BANT/MEDDIC, combined_completion on QualificationState. ConversationState contains full deal lifecycle tracking. EscalationReport matches the locked decision format from CONTEXT.md.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create persona-adapted prompt system with Chris Voss methodology</name>
  <files>
    src/app/agents/sales/prompts.py
  </files>
  <action>
    **src/app/agents/sales/prompts.py** -- System prompts and prompt builders:

    1. **PERSONA_CONFIGS** dict[PersonaType, dict]: Configuration for each persona type, following locked decisions from CONTEXT.md:
       - PersonaType.IC:
         - tone: "conversational, friendly, peer-to-peer"
         - formality: "low"
         - message_length: "moderate, get to the point but be warm"
         - question_style: "direct but curious, show genuine interest in their day-to-day"
         - voss_emphasis: "mirroring, labels ('It sounds like...', 'It seems like...')"
         - lead_with: "empathy for their challenges, practical solutions"
         - avoid: "jargon-heavy business cases, ROI calculations"
       - PersonaType.MANAGER:
         - tone: "balanced, strategic yet approachable"
         - formality: "medium"
         - message_length: "contextual - thorough when needed, concise when appropriate"
         - question_style: "calibrated questions ('How are you thinking about...?', 'What does success look like for...?')"
         - voss_emphasis: "calibrated questions, tactical empathy, strategic labels"
         - lead_with: "strategic alignment, team impact, efficiency gains"
         - avoid: "being overly casual or overly formal"
       - PersonaType.C_SUITE:
         - tone: "formal, business-case focused, executive-concise"
         - formality: "high"
         - message_length: "concise, lead with business impact, respect their time"
         - question_style: "strategic outcome-focused ('What would it mean for the organization if...?')"
         - voss_emphasis: "accusation audits ('You're probably thinking...'), strategic silence, late-night FM DJ voice"
         - lead_with: "business impact, ROI, competitive advantage, revenue outcomes"
         - avoid: "technical details, feature lists, overly long messages"

    2. **VOSS_METHODOLOGY_PROMPT** (str constant): Core Chris Voss tactical empathy instructions embedded in ALL persona prompts. Must include:
       - Tactical empathy: Demonstrate understanding of their world before asking for anything
       - Mirroring: Repeat the last 1-3 critical words they said to encourage elaboration
       - Labeling: Use "It seems like...", "It sounds like...", "It looks like..." to name emotions and situations
       - Calibrated questions: "How" and "What" questions that make them feel in control ("How would you like to proceed?", "What challenges are you facing with...?")
       - Accusation audit: Preemptively address objections ("You're probably thinking this is just another sales pitch...")
       - Give value first: Share relevant insights before asking questions. Earn the right to probe.
       - NEVER interrogate: Qualification data must emerge from natural conversation, not a checklist. Weave discovery into the flow.

    3. **CHANNEL_CONFIGS** dict[str, dict]: Channel-specific guidance:
       - "email":
         - format: "Structured with clear sections. Subject line is critical. Professional greeting and sign-off."
         - length: "Contextual based on stage and persona, but generally 3-5 paragraphs for outreach, shorter for follow-ups."
         - threading: "Always reference prior conversation context when replying. Maintain thread continuity."
         - cta: "End with a clear, single call-to-action."
       - "chat":
         - format: "Lighter, shorter messages. More conversational like Slack. Can use bullet points."
         - length: "2-4 sentences per message typically. Break long thoughts into multiple messages."
         - threading: "Reference recent context but keep it brief."
         - cta: "Casual, direct asks."

    4. **build_system_prompt(persona: PersonaType, channel: Channel, deal_stage: DealStage) -> str**: Composes the full system prompt by combining:
       - Role definition ("You are a top 1% enterprise sales professional...")
       - VOSS_METHODOLOGY_PROMPT
       - Persona-specific guidance from PERSONA_CONFIGS[persona]
       - Channel-specific guidance from CHANNEL_CONFIGS[channel]
       - Deal stage context (what to focus on at this stage: prospecting=rapport, discovery=pain/needs, qualification=BANT+MEDDIC, evaluation=differentiation, negotiation=value-defense)
       - Key rules: Never mention you are an AI. Never fabricate customer data. Always ground in source knowledge. Fill qualification gaps opportunistically, never interrogate.

    5. **build_email_prompt(persona: PersonaType, deal_stage: DealStage, context_summary: str, task_description: str) -> list[dict]**: Returns messages list for LLM call. System message from build_system_prompt(persona, Channel.EMAIL, deal_stage). User message includes context_summary and task_description.

    6. **build_chat_prompt(persona: PersonaType, deal_stage: DealStage, context_summary: str, task_description: str) -> list[dict]**: Same pattern as build_email_prompt but with Channel.CHAT.

    7. **build_qualification_extraction_prompt(conversation_text: str, existing_state: dict | None = None) -> list[dict]**: Returns messages list for structured qualification signal extraction. System prompt instructs the LLM to:
       - Extract BANT and MEDDIC signals from the conversation
       - Be conservative: only mark fields as identified if clear evidence exists
       - Preserve existing signals: if existing_state provided, only update fields with new evidence (avoid overwriting -- Pitfall 3 from research)
       - Include evidence quotes from the conversation for each identified signal
       - Assess overall confidence (0.0-1.0) based on signal completeness and evidence strength
       - Suggest 2-3 calibrated questions (Voss style) to fill the biggest qualification gaps

    8. **build_next_action_prompt(conversation_state_summary: str, recent_interactions: str) -> list[dict]**: Returns messages list for next-action recommendation. System prompt instructs the LLM to:
       - Analyze conversation state (deal stage, qualification completeness, engagement signals)
       - Recommend 1-3 next actions with priority and timing
       - Consider follow-up triggers: deal milestones, engagement signals, time since last interaction
       - Check escalation conditions: confidence < 0.7, high-stakes moment, customer request for human
       - Output structured recommendations

    All prompts must be well-structured, specific, and include examples where helpful. The persona adaptation must affect the ENTIRE message generation, not just greetings (Pitfall 4 from research).
  </action>
  <verify>
    `python -c "from src.app.agents.sales.prompts import build_system_prompt, build_email_prompt, build_chat_prompt, build_qualification_extraction_prompt, PERSONA_CONFIGS; print('All prompt functions import OK')"` succeeds.
    `python -c "
from src.app.agents.sales.prompts import build_system_prompt
from src.app.agents.sales.schemas import PersonaType, Channel, DealStage
p1 = build_system_prompt(PersonaType.IC, Channel.EMAIL, DealStage.DISCOVERY)
p2 = build_system_prompt(PersonaType.C_SUITE, Channel.EMAIL, DealStage.DISCOVERY)
assert 'conversational' in p1.lower() or 'friendly' in p1.lower()
assert 'business impact' in p2.lower() or 'concise' in p2.lower()
assert 'tactical empathy' in p1.lower() or 'mirroring' in p1.lower()
print('Persona differentiation OK')
"` prints "Persona differentiation OK".
  </verify>
  <done>
    PERSONA_CONFIGS covers IC/Manager/C-suite with distinct tone, formality, length, question style, and Voss emphasis. VOSS_METHODOLOGY_PROMPT embeds tactical empathy, mirroring, labeling, calibrated questions, and accusation audits. Channel configs differentiate email (structured/formal) from chat (lighter/shorter). build_system_prompt composes persona + channel + deal stage + Voss methodology into a complete system prompt. build_email_prompt, build_chat_prompt, build_qualification_extraction_prompt, and build_next_action_prompt provide ready-to-use message lists for LLM calls.
  </done>
</task>

</tasks>

<verification>
1. All schemas importable from src.app.agents.sales.schemas
2. All prompt functions importable from src.app.agents.sales.prompts
3. BANTSignals and MEDDICSignals have completion_score properties that calculate correctly
4. ConversationState can be instantiated with minimal required fields and sensible defaults
5. build_system_prompt produces distinctly different prompts for IC vs C-suite
6. All prompts include Chris Voss methodology elements
7. Channel differentiation produces email-appropriate vs chat-appropriate guidance
</verification>

<success_criteria>
- 9 Pydantic models defined covering all Phase 4 data needs (BANT, MEDDIC, QualificationState, ConversationState, DealStage, PersonaType, Channel, EscalationReport, NextAction)
- PERSONA_CONFIGS with 3 distinct persona profiles matching CONTEXT.md locked decisions
- VOSS_METHODOLOGY_PROMPT with tactical empathy, mirroring, labeling, calibrated questions
- CHANNEL_CONFIGS differentiating email from chat
- 5 prompt builder functions (system, email, chat, qualification extraction, next action)
- Persona adaptation affects entire message generation, not just greetings
</success_criteria>

<output>
After completion, create `.planning/phases/04-sales-agent-core/04-02-SUMMARY.md`
</output>
