---
phase: 05-deal-management
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/deals/detection.py
  - src/app/deals/political.py
  - src/app/deals/plans.py
  - tests/test_deal_detection.py
  - tests/test_deal_political.py
autonomous: true

must_haves:
  truths:
    - "OpportunityDetector extracts opportunity signals from conversation text using instructor+litellm pattern with >80% creation threshold"
    - "PoliticalMapper assigns stakeholder scores using title heuristics with LLM refinement and respects human overrides"
    - "PlanManager generates and updates account plans and opportunity plans from accumulated conversation data"
    - "Opportunity detection includes existing opportunities in prompt to prevent duplicates (Pitfall 3)"
    - "Political scores track their source (heuristic/conversation_signal/human_override) per Pitfall 5"
  artifacts:
    - path: "src/app/deals/detection.py"
      provides: "OpportunityDetector with LLM-powered signal extraction"
      contains: "class OpportunityDetector"
    - path: "src/app/deals/political.py"
      provides: "PoliticalMapper with hybrid title+LLM+override scoring"
      contains: "class PoliticalMapper"
    - path: "src/app/deals/plans.py"
      provides: "PlanManager for account and opportunity plan lifecycle"
      contains: "class PlanManager"
    - path: "tests/test_deal_detection.py"
      provides: "Unit tests for opportunity detection and political mapping"
  key_links:
    - from: "src/app/deals/detection.py"
      to: "instructor + litellm"
      via: "instructor.from_litellm(litellm.acompletion) pattern"
      pattern: "instructor.from_litellm"
    - from: "src/app/deals/political.py"
      to: "src/app/deals/schemas.py"
      via: "StakeholderRole, StakeholderScores, ScoreSource imports"
      pattern: "from src.app.deals.schemas import"
    - from: "src/app/deals/plans.py"
      to: "src/app/deals/repository.py"
      via: "DealRepository for plan persistence"
      pattern: "DealRepository"
---

<objective>
Build the intelligence layer for deal management: opportunity signal detection from conversations, political mapping with quantitative scoring, and plan generation/update lifecycle.

Purpose: These three services are the "brain" of deal management -- they analyze conversations to detect deals, map organizational power structures, and maintain living strategy documents. They consume existing qualification data (Phase 4) and write to the deal management data layer (Plan 01).

Output: OpportunityDetector, PoliticalMapper, PlanManager classes with comprehensive unit tests.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deal-management/05-RESEARCH.md
@.planning/phases/05-deal-management/05-CONTEXT.md
@.planning/phases/05-deal-management/05-01-SUMMARY.md

# Existing patterns to follow:
@src/app/agents/sales/qualification.py
@src/app/agents/sales/schemas.py
@src/app/deals/schemas.py
@src/app/deals/repository.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: OpportunityDetector and PoliticalMapper</name>
  <files>
    src/app/deals/detection.py
    src/app/deals/political.py
  </files>
  <action>
**detection.py** -- OpportunityDetector following QualificationExtractor pattern from Phase 4:

```python
class OpportunityDetector:
    CREATION_THRESHOLD = 0.80  # Locked decision: >80% for precision bias
    UPDATE_THRESHOLD = 0.70    # Lower bar for updating existing

    def __init__(self, model: str = "reasoning") -> None:
        self._model = model
```

Methods:
- `async detect_signals(conversation_text, conversation_state: ConversationState, existing_opportunities: list[OpportunityRead]) -> OpportunitySignals`
  - Uses `instructor.from_litellm(litellm.acompletion)` with response_model=OpportunitySignals
  - System prompt includes existing opportunities list (prevents duplicates per Pitfall 3)
  - Prompt instructs: new opportunity ONLY if different product line OR >3 months timeline difference
  - temperature=0.1 for deterministic extraction
  - Returns structured OpportunitySignals with deal_potential_confidence, product_line, is_new_opportunity, etc.

- `should_create_opportunity(signals: OpportunitySignals) -> bool`
  - Returns True if signals.deal_potential_confidence >= CREATION_THRESHOLD AND signals.is_new_opportunity

- `should_update_opportunity(signals: OpportunitySignals) -> bool`
  - Returns True if signals.deal_potential_confidence >= UPDATE_THRESHOLD AND NOT signals.is_new_opportunity AND signals.matching_opportunity_id is not None

Build the detection prompt in a `_build_detection_prompt()` method following the pattern from RESEARCH.md code examples. Include the existing opportunities list in the system message. Include conversation state summary (deal_stage, qualification completion, interaction_count).

**political.py** -- PoliticalMapper with hybrid scoring:

```python
class PoliticalMapper:
    # Title-based heuristic baselines
    TITLE_HEURISTICS: dict[str, dict[str, int]] = {
        "c-suite": {"decision_power": 9, "influence_level": 8, "relationship_strength": 3},
        "vp": {"decision_power": 8, "influence_level": 7, "relationship_strength": 3},
        "director": {"decision_power": 6, "influence_level": 6, "relationship_strength": 3},
        "manager": {"decision_power": 4, "influence_level": 5, "relationship_strength": 3},
        "ic": {"decision_power": 2, "influence_level": 3, "relationship_strength": 3},
    }

    def __init__(self, model: str = "fast") -> None:
        self._model = model
```

Methods:
- `score_from_title(title: str | None) -> StakeholderScores`
  - Maps title keywords (CEO, CTO, VP, Director, Manager, etc.) to heuristic baselines
  - Returns StakeholderScores with source="heuristic" for all dimensions

- `async refine_from_conversation(stakeholder: StakeholderRead, conversation_text: str) -> tuple[StakeholderScores, dict[str, str]]`
  - Uses instructor+litellm to extract relationship signals from conversation
  - Returns updated scores + evidence dict (e.g., {"influence_level": "Mentioned need to get Sarah's approval"})
  - Conversation signals can ONLY increase scores, never decrease (per Pitfall 5)
  - Returns same scores if LLM fails (fail-open pattern from 02-03)

- `apply_override(current_scores: StakeholderScores, overrides: dict[str, int]) -> StakeholderScores`
  - Human overrides always win (per Pitfall 5)
  - Clamps values to 0-10 range

- `detect_roles_from_conversation(conversation_text: str, stakeholder_name: str) -> list[StakeholderRole]`
  - Uses instructor+litellm to detect roles from conversation context
  - Looks for signals like "I make the final call" (decision_maker), "I'll champion this internally" (champion), "I have concerns about..." (potential blocker)
  - Returns list of StakeholderRole (multiple allowed per CONTEXT.md)
  </action>
  <verify>
    python -c "from src.app.deals.detection import OpportunityDetector; print('Detection OK')"
    python -c "from src.app.deals.political import PoliticalMapper; print('Political OK')"
  </verify>
  <done>OpportunityDetector extracts signals via instructor+litellm with >80% creation threshold, PoliticalMapper uses title heuristics + LLM refinement + human overrides with score source tracking</done>
</task>

<task type="auto">
  <name>Task 2: PlanManager and unit tests</name>
  <files>
    src/app/deals/plans.py
    tests/test_deal_detection.py
    tests/test_deal_political.py
  </files>
  <action>
**plans.py** -- PlanManager for account and opportunity plan lifecycle:

```python
class PlanManager:
    MAX_KEY_EVENTS = 50       # Pitfall 4: prevent unbounded growth
    MAX_INTERACTIONS = 20     # Pitfall 4
    MAX_ACTION_ITEMS = 30     # Pitfall 4

    def __init__(self, repository: DealRepository) -> None:
        self._repo = repository
```

Methods:
- `async create_or_update_account_plan(tenant_id, account_id, conversation_state: ConversationState, stakeholders: list[StakeholderRead]) -> AccountPlanData`
  - Gets existing plan from repository (or creates new)
  - Updates company_profile from conversation signals (structured data assembly, not LLM -- per RESEARCH.md Open Question 4)
  - Appends to relationship_history.interaction_summaries (capped at MAX_INTERACTIONS)
  - Updates active_opportunity_ids from repository query
  - Saves via repository.upsert_account_plan()

- `async create_or_update_opportunity_plan(tenant_id, opportunity_id, opportunity: OpportunityRead, conversation_state: ConversationState, stakeholders: list[StakeholderRead]) -> OpportunityPlanData`
  - Gets existing plan from repository (or creates new)
  - Updates core_deal from opportunity data (product_line, value, stage, probability, close_date)
  - Updates qualification_tracking from conversation_state.qualification (snapshot BANT/MEDDIC)
  - Updates stakeholder_map from stakeholders list
  - Manages action_items (cap at MAX_ACTION_ITEMS, prune completed)
  - Saves via repository.upsert_opportunity_plan()

- `_build_interaction_summary(conversation_state: ConversationState) -> InteractionSummary`
  - Creates a summary entry for relationship history from current conversation state

- `_trim_list(items: list, max_size: int) -> list`
  - Trims list to max_size, keeping most recent items (per Pitfall 4)

**tests/test_deal_detection.py** -- Unit tests for OpportunityDetector:
- test_should_create_opportunity_above_threshold: signals with confidence=0.85, is_new=True -> True
- test_should_not_create_below_threshold: signals with confidence=0.75, is_new=True -> False
- test_should_update_existing: signals with confidence=0.72, is_new=False, matching_id set -> True
- test_should_not_update_below_threshold: signals with confidence=0.60 -> False

**tests/test_deal_political.py** -- Unit tests for PoliticalMapper:
- test_score_from_title_ceo: title "CEO" -> decision_power=9, influence_level=8
- test_score_from_title_manager: title "Product Manager" -> decision_power=4, influence_level=5
- test_score_from_title_none: None title -> default IC scores
- test_apply_override_wins: override decision_power=10 always wins
- test_apply_override_clamps: override with value 15 clamps to 10

For PlanManager:
- test_trim_list_under_limit: list of 5 with max 10 -> unchanged
- test_trim_list_over_limit: list of 25 with max 20 -> last 20 items
- test_create_account_plan_new: no existing plan -> creates fresh plan
- test_update_account_plan_appends_interaction: existing plan gets new interaction summary
  </action>
  <verify>
    cd /Users/RAZER/Documents/projects/sales\ army && python -m pytest tests/test_deal_detection.py tests/test_deal_political.py -v --timeout=30 2>&1 | tail -20
    cd /Users/RAZER/Documents/projects/sales\ army && python -m pytest tests/ -x -q --timeout=30 2>&1 | tail -5
  </verify>
  <done>PlanManager generates and updates plans with bounded growth (Pitfall 4), all detection/political/plan tests pass, all existing tests still pass</done>
</task>

</tasks>

<verification>
1. OpportunityDetector uses instructor.from_litellm pattern (not custom JSON parsing)
2. Creation threshold is 0.80 (locked decision)
3. PoliticalMapper title heuristics cover CEO/VP/Director/Manager/IC
4. Score sources tracked as ScoreSource enum (heuristic/conversation_signal/human_override)
5. Human overrides always win in apply_override()
6. Conversation signals can only increase scores (never decrease) in refine_from_conversation()
7. PlanManager caps all list fields per Pitfall 4 thresholds
8. All new tests pass, all existing 465 tests pass
</verification>

<success_criteria>
- OpportunityDetector imports and has CREATION_THRESHOLD=0.80
- PoliticalMapper.score_from_title("CEO") returns decision_power >= 8
- PlanManager.MAX_KEY_EVENTS == 50, MAX_INTERACTIONS == 20
- All new tests pass
- All 465 existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-deal-management/05-02-SUMMARY.md`
</output>
