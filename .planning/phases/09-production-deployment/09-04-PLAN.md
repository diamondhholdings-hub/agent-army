---
phase: 09-production-deployment
plan: 04
type: execute
wave: 2
depends_on: ["09-01", "09-02", "09-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Pushing to main triggers GitHub Actions and the production deploy job runs green"
    - "Cloud Run production service URL responds on /health with status ok"
    - "Cloud Run /health/ready returns 200 with all 4 dependency checks passing"
    - "Vercel webapp URL loads in a browser and shows the avatar interface"
    - "verify_production.py reports SC1 PASS and SC2 PASS"
  artifacts: []
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "Cloud Run production service"
      via: "deploy-cloudrun@v3 deployment"
      pattern: "agent-army-api"
    - from: "scripts/verify_production.py"
      to: "Cloud Run /health/ready"
      via: "HTTP GET request"
      pattern: "health/ready"
---

<objective>
Trigger the first production deployment and verify that SC1 (webapp) and SC2 (health endpoint) pass. This is the moment of truth -- code changes from Plan 01 and CI/CD from Plan 02 are deployed, credentials from Plan 03 are used.

Purpose: SC1 and SC2 are the first two success criteria for the phase. They must pass before SC3-SC5 can be attempted. This plan validates that the entire deployment pipeline works end-to-end.

Output: Live production services (Cloud Run backend + Vercel webapp) with passing smoke tests.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-production-deployment/09-01-SUMMARY.md
@.planning/phases/09-production-deployment/09-02-SUMMARY.md
@.planning/phases/09-production-deployment/09-03-SUMMARY.md

@.github/workflows/deploy.yml
@scripts/verify_production.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Trigger production deployment and monitor pipeline</name>
  <files></files>
  <action>
This task orchestrates the first production deployment. The code changes from Plans 01-02 need to be pushed to main to trigger the CI/CD pipeline.

**Step 1: Verify all code changes are committed and pushed**
Check git status for any uncommitted changes from Plans 01-02. If changes exist, commit them:
```bash
git add src/app/api/v1/health.py src/app/config.py src/app/main.py .github/workflows/deploy.yml scripts/verify_production.py
git commit -m "feat(09): production deployment - code fixes and CI/CD pipeline"
git push origin main
```

**Step 2: Monitor GitHub Actions pipeline**
Use `gh` CLI to watch the deployment:
```bash
gh run list --limit 5
gh run watch  # Watch the latest run
```

If the staging job fails (expected if staging secrets aren't configured), check if the production job was configured to run independently. If staging failure blocks production, update deploy.yml to remove the `needs: [deploy-staging]` dependency and re-push.

**Step 3: Capture the Cloud Run URL**
After the deploy-production job completes:
```bash
gh run view --log  # Find the Cloud Run URL in the deploy step output
```
Or check the GitHub Actions run log for the deploy step output URL.

**Step 4: Verify Vercel deployment**
Check that the Vercel auto-deploy triggered:
- The meeting-bot-webapp should have auto-deployed on the push to main
- Capture the Vercel production URL from the Vercel dashboard or `vercel ls` if CLI is available

**Step 5: Run smoke tests locally**
```bash
python scripts/verify_production.py \
  --webapp-url "VERCEL_URL_HERE" \
  --backend-url "CLOUD_RUN_URL_HERE"
```

**Troubleshooting:**
- If deploy fails with "workload identity pool not found": WIF needs to be created (see docs/credential-setup.md Section 8)
- If deploy fails with "secret not found": Missing GitHub Actions secrets (check Section 9 of credential guide)
- If health endpoint returns 503: Check which dependency check failed in the response body
- If Vercel 404: Check that the GitHub repo is connected in Vercel dashboard
  </action>
  <verify>
Run: `python scripts/verify_production.py --webapp-url "$WEBAPP_URL" --backend-url "$BACKEND_URL"`
Both SC1 and SC2 should report PASS.

Also verify via direct curl:
```bash
curl -s "$BACKEND_URL/health" | python -m json.tool
curl -s "$BACKEND_URL/health/ready" | python -m json.tool
curl -sI "$WEBAPP_URL" | head -5
```
  </verify>
  <done>
GitHub Actions deploy-production job ran green. Cloud Run service is live at its URL. verify_production.py reports SC1 PASS (webapp returns 200) and SC2 PASS (health/ready returns 200 with all checks ok).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Developer verifies SC1 and SC2 in browser</name>
  <what-built>
Production deployment of Sales Agent backend (Cloud Run) and webapp (Vercel). The automated smoke test script has verified SC1 and SC2 programmatically.
  </what-built>
  <how-to-verify>
1. Open the Vercel webapp URL in your browser. You should see the avatar/meeting bot interface (SC1).
2. Open the Cloud Run URL + `/health/ready` in your browser. You should see JSON with `"status": "ready"` and all 4 dependency checks showing `"ok"` (SC2).
3. Open the Cloud Run URL + `/health` to see basic liveness check.
4. Check the GitHub Actions run log to confirm the deploy-production job completed successfully.
  </how-to-verify>
  <resume-signal>Type "SC1 and SC2 verified" or describe any issues seen in the browser.</resume-signal>
</task>

</tasks>

<verification>
1. GitHub Actions deploy-production job status is "success"
2. `curl $BACKEND_URL/health/ready` returns 200 with `{"status": "ready"}`
3. `curl $WEBAPP_URL` returns 200
4. `python scripts/verify_production.py` exits 0
5. Developer visually confirmed both in browser
</verification>

<success_criteria>
- Cloud Run production service is live and accessible at its public URL
- /health/ready returns 200 with database=ok, redis=ok, qdrant=ok, litellm=ok
- Vercel webapp loads in browser showing the avatar interface
- Automated smoke tests pass (SC1 + SC2)
- Developer has visually verified both services
</success_criteria>

<output>
After completion, create `.planning/phases/09-production-deployment/09-04-SUMMARY.md`
</output>
