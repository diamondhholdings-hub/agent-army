---
phase: 09-production-deployment
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/credential-setup.md
autonomous: false
user_setup:
  - service: google-workspace
    why: "Service account with domain-wide delegation for Gmail/Calendar"
    env_vars:
      - name: GOOGLE_SERVICE_ACCOUNT_JSON_B64
        source: "GCP Console -> IAM -> Service Accounts -> Create key -> JSON -> base64 encode"
      - name: GOOGLE_DELEGATED_USER_EMAIL
        source: "Google Workspace Admin -> Directory -> Users (agent@skyvera.com)"
    dashboard_config:
      - task: "Create service account and download JSON key"
        location: "GCP Console -> IAM & Admin -> Service Accounts"
      - task: "Enable Gmail API, Calendar API, Chat API"
        location: "GCP Console -> APIs & Services -> Library"
      - task: "Configure domain-wide delegation"
        location: "Google Admin Console -> Security -> API controls -> Domain-wide Delegation"
      - task: "Create agent email account"
        location: "Google Workspace Admin -> Directory -> Users -> Add new user"
  - service: notion
    why: "CRM integration for deal pipeline sync"
    env_vars:
      - name: NOTION_TOKEN
        source: "notion.so/my-integrations -> New integration -> Copy token"
      - name: NOTION_DATABASE_ID
        source: "Notion database URL -> extract ID from URL"
    dashboard_config:
      - task: "Create internal integration"
        location: "notion.so/my-integrations"
      - task: "Share database with integration"
        location: "Database page -> ... -> Add connections"
  - service: github-actions
    why: "All 25 production secrets must be configured before first deploy"
    env_vars:
      - name: GCP_PROJECT_ID
        source: "GCP Console -> Dashboard"
      - name: GCP_PROJECT_NUMBER
        source: "GCP Console -> Dashboard"
      - name: GCP_REGION
        source: "Developer choice (e.g. us-central1)"
      - name: PROD_DATABASE_URL
        source: "Managed Postgres provider"
      - name: PROD_REDIS_URL
        source: "Managed Redis provider"
      - name: PROD_JWT_SECRET_KEY
        source: "Generate with: openssl rand -hex 32"
    dashboard_config:
      - task: "Add all 25 secrets to repository"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions"
  - service: qdrant-cloud
    why: "Production vector database for knowledge base"
    env_vars:
      - name: KNOWLEDGE_QDRANT_URL
        source: "Qdrant Cloud Console -> Cluster -> URL"
      - name: KNOWLEDGE_QDRANT_API_KEY
        source: "Qdrant Cloud Console -> Cluster -> API Key"
    dashboard_config:
      - task: "Create free-tier cluster"
        location: "cloud.qdrant.io"
  - service: gcp-wif
    why: "Workload Identity Federation for GitHub Actions to authenticate to GCP"
    dashboard_config:
      - task: "Create WIF pool and provider if not exists"
        location: "GCP Console -> IAM -> Workload Identity Federation"

must_haves:
  truths:
    - "A developer can follow the credential setup guide to provision all production credentials from scratch"
    - "Every GitHub Actions secret needed for the deploy workflow is documented with its source"
    - "Google Workspace domain-wide delegation steps are complete and specific (not generic)"
    - "Notion CRM integration setup is documented with database property mapping"
  artifacts:
    - path: "docs/credential-setup.md"
      provides: "Complete credential provisioning guide"
      contains: "domain-wide delegation"
  key_links:
    - from: "docs/credential-setup.md"
      to: ".github/workflows/deploy.yml"
      via: "Documents every secret referenced in deploy.yml"
      pattern: "GOOGLE_SERVICE_ACCOUNT_JSON_B64"
---

<objective>
Create a comprehensive credential provisioning guide that documents every step needed to set up production credentials from scratch -- Google Workspace service account with domain-wide delegation, Notion CRM integration, Qdrant Cloud cluster, GCP Workload Identity Federation, and all 25 GitHub Actions secrets.

Purpose: The user decision states "all credential provisioning steps should be documented in the plan so nothing is assumed pre-existing." This guide ensures the developer can provision everything without guessing. SC3 (Google Workspace) and SC4 (Notion CRM) depend on these credentials being correctly configured.

Output: `docs/credential-setup.md` -- a step-by-step provisioning guide.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-production-deployment/09-RESEARCH.md
@.planning/phases/09-production-deployment/09-CONTEXT.md

@.github/workflows/deploy.yml
@src/app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credential provisioning guide</name>
  <files>docs/credential-setup.md</files>
  <action>
Create `docs/credential-setup.md` with the following sections. The guide must be specific enough that someone unfamiliar with these services can follow it step by step.

**Section 1: Overview**
- List all external services that need configuration
- Estimated total time: 30-45 minutes (plus up to 24h for Google DWD propagation)
- Order of operations: GCP first (longest propagation), then Notion, then GitHub secrets, then verify

**Section 2: GCP Project Setup**
- Verify GCP project exists (or create one)
- Note PROJECT_ID and PROJECT_NUMBER from dashboard
- Enable APIs: Gmail API, Google Calendar API, Google Chat API

**Section 3: Service Account Creation**
Step-by-step:
1. GCP Console -> IAM & Admin -> Service Accounts -> Create Service Account
2. Name: `sales-agent-service`
3. No additional roles needed (delegation handles access)
4. Click into the new service account -> Keys -> Add Key -> Create new key -> JSON
5. Download the JSON file
6. Note the Client ID (numeric) from the service account details page
7. Base64-encode the JSON: `cat service-account.json | base64 -w 0` (Linux) or `cat service-account.json | base64` (macOS)
8. Store the base64 string -- this becomes GOOGLE_SERVICE_ACCOUNT_JSON_B64

**Section 4: Domain-Wide Delegation**
Step-by-step:
1. Go to admin.google.com (must be Workspace Admin)
2. Security -> Access and data control -> API controls -> Manage Domain Wide Delegation
3. Click "Add new"
4. Client ID: paste the numeric Client ID from Step 3.6
5. OAuth Scopes (comma-separated, no spaces):
   `https://www.googleapis.com/auth/gmail.send,https://www.googleapis.com/auth/gmail.readonly,https://www.googleapis.com/auth/gmail.modify,https://www.googleapis.com/auth/calendar.readonly,https://www.googleapis.com/auth/calendar.events.readonly`
6. Click "Authorize"
7. Wait 5-15 minutes for propagation (can take up to 24h in rare cases)

**Section 5: Agent Email Account**
1. admin.google.com -> Directory -> Users -> Add new user
2. Email: `agent@skyvera.com` (or chosen agent email)
3. This is the GOOGLE_DELEGATED_USER_EMAIL value

**Section 6: Notion CRM Integration**
1. Go to notion.so/my-integrations -> New integration
2. Name: "Sales Agent Production"
3. Associated workspace: Skyvera production workspace
4. Capabilities: Read content, Update content, Insert content
5. Copy Internal Integration Secret -> this becomes NOTION_TOKEN
6. Open the deals pipeline database in Notion
7. Click "..." -> Add connections -> Select "Sales Agent Production"
8. Get database ID from URL: `https://www.notion.so/WORKSPACE/DATABASE_ID?v=...`
9. Verify database properties match expected fields: "Deal Name" (title), "Stage" (select), "Value" (number), "Close Date" (date), "Product" (select), "Probability" (number), "Source" (select), "Contact" (rich_text), "Email" (email)

**Section 7: Qdrant Cloud**
1. Go to cloud.qdrant.io and create account (if not exists)
2. Create a free-tier cluster
3. Note the cluster URL -> KNOWLEDGE_QDRANT_URL
4. Generate an API key -> KNOWLEDGE_QDRANT_API_KEY
5. Collections will be auto-created by the application on first use

**Section 8: Workload Identity Federation (GCP -> GitHub Actions)**
If not already set up:
1. Enable IAM Credentials API in GCP
2. Create WIF pool named "github"
3. Create OIDC provider named "github" with issuer URL `https://token.actions.githubusercontent.com`
4. Create service account `github-actions@PROJECT_ID.iam.gserviceaccount.com` with roles: Cloud Run Admin, Cloud Build Editor, Service Account User, Storage Admin
5. Grant the WIF pool access to this service account

Include the exact gcloud commands for each step (copy-pasteable).

**Section 9: GitHub Actions Secrets**
Complete table of all 25 secrets with:
- Secret name (exact match for deploy.yml)
- Description
- Where to get it
- Example format (sanitized)

Use the inventory from 09-RESEARCH.md as the source of truth.

**Section 10: Vercel Webapp**
1. Verify Vercel project is connected to GitHub repo
2. If not: Vercel Dashboard -> Add New Project -> Import Git Repository
3. Set production branch to `main`
4. Note the production URL -> this becomes MEETING_BOT_WEBAPP_URL

**Section 11: Post-Setup Verification Checklist**
A checklist the developer can run through to confirm everything is configured before first deploy.
  </action>
  <verify>
Verify file exists and contains all major sections:
- "Domain-Wide Delegation" section exists
- "Notion CRM" section exists
- "GitHub Actions Secrets" section with a table
- "Qdrant Cloud" section exists
- "Workload Identity Federation" section exists
- File is at least 200 lines (comprehensive guide)
  </verify>
  <done>
`docs/credential-setup.md` exists with complete, step-by-step provisioning instructions for all production credentials. Every GitHub Actions secret from deploy.yml is documented. A developer can follow this guide from zero to fully configured without guessing.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Developer provisions all production credentials</name>
  <action>
The developer must follow `docs/credential-setup.md` to provision all production credentials.

This is a human-action checkpoint because it involves:
- Creating accounts and service accounts in GCP Console
- Configuring domain-wide delegation in Google Admin Console
- Creating a Notion integration and sharing databases
- Adding 25 secrets to GitHub repository settings
- Provisioning or verifying Qdrant Cloud cluster
- Verifying Vercel deployment connection

None of these can be automated by Claude (they require authenticated dashboard access to external services).
  </action>
  <how-to-verify>
Follow `docs/credential-setup.md` from top to bottom. After completing all sections, run the post-setup verification checklist at the end of the guide.
  </how-to-verify>
  <resume-signal>Type "credentials configured" when all secrets are set in GitHub Actions and external services are provisioned, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
1. `docs/credential-setup.md` exists and is comprehensive
2. Developer confirms all 25 GitHub Actions secrets are configured
3. Developer confirms Google Workspace DWD is authorized
4. Developer confirms Notion integration is created and database is shared
</verification>

<success_criteria>
- docs/credential-setup.md covers all 5 external services (GCP, Google Workspace, Notion, Qdrant, Vercel)
- All 25 GitHub Actions secrets are documented with exact names and sources
- Developer has provisioned all credentials and confirmed readiness
</success_criteria>

<output>
After completion, create `.planning/phases/09-production-deployment/09-03-SUMMARY.md`
</output>
