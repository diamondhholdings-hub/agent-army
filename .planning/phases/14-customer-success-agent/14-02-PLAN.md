---
phase: 14-customer-success-agent
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/app/agents/customer_success/health_scorer.py
  - src/app/agents/customer_success/notion_adapter.py
autonomous: true

must_haves:
  truths:
    - "CSMHealthScorer.score(signals) returns CSMHealthScore with correct rag (GREEN >= 70, AMBER >= 40, RED < 40)"
    - "TAM correlation: RED tam_health_rag caps CSM score at 0.85x; AMBER caps at 0.95x; GREEN = no cap"
    - "Churn risk is critical when health=RED and days_to_renewal <= 60 (contract_proximity trigger)"
    - "Churn risk is high when usage_trend=declining or inactive for 3+ metrics (behavioral trigger)"
    - "NotionCSMAdapter.get_account() returns dict with both id and account_id keys"
    - "NotionCSMAdapter.update_health_score() writes CSM health score to account page"
    - "NotionCSMAdapter.create_qbr_page() creates a structured Notion page in CSM QBR database"
    - "NotionCSMAdapter.query_all_accounts() returns list of account dicts"
  artifacts:
    - path: "src/app/agents/customer_success/health_scorer.py"
      provides: "Deterministic 11-signal CSM health scorer"
      contains: "class CSMHealthScorer"
    - path: "src/app/agents/customer_success/notion_adapter.py"
      provides: "Notion CRUD for CSM health records, QBR pages, expansion opportunities"
      contains: "class NotionCSMAdapter"
  key_links:
    - from: "src/app/agents/customer_success/health_scorer.py"
      to: "src/app/agents/customer_success/schemas.py"
      via: "CSMHealthSignals input, CSMHealthScore output"
      pattern: "from.*schemas import CSMHealthSignals"
    - from: "src/app/agents/customer_success/notion_adapter.py"
      to: "Notion CSM QBR database"
      via: "parent={database_id: NOTION_CSM_QBR_DATABASE_ID}"
      pattern: "database_id.*NOTION_CSM_QBR"
---

<objective>
Build the CSM health scorer (deterministic 11-signal algorithm) and the NotionCSMAdapter (Notion CRUD for health records, QBR pages, and expansion opportunities). These are the two infrastructure components the CSM agent depends on.

Purpose: The health scorer is the commercial-layer analog to TAM's HealthScorer — pure Python, no LLM, deterministic. The Notion adapter gives the agent persistence for all CSM outputs.
Output: health_scorer.py with CSMHealthScorer, notion_adapter.py with NotionCSMAdapter.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/14-customer-success-agent/14-CONTEXT.md
@.planning/phases/14-customer-success-agent/14-RESEARCH.md
@.planning/phases/14-customer-success-agent/14-01-SUMMARY.md
@src/app/agents/technical_account_manager/health_scorer.py
@src/app/agents/technical_account_manager/notion_tam.py
@src/app/agents/customer_success/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSMHealthScorer — deterministic 11-signal scoring</name>
  <files>
    src/app/agents/customer_success/health_scorer.py
  </files>
  <action>
Create src/app/agents/customer_success/health_scorer.py. Pattern exactly mirrors TAM health_scorer.py (keyword-only constructor, pure Python, no LLM).

**CSMHealthScorer class:**

Constructor (keyword-only args for per-tenant customization):
```python
def __init__(
    self,
    *,
    green_threshold: float = 70.0,
    amber_threshold: float = 40.0,
    churn_window_days: int = 60,  # contract proximity trigger
) -> None:
```

**Signal weights (hardcoded, total = 100):**
- feature_adoption_rate: weight 20 (most important — core product value)
- usage_trend: weight 15 (growing=15, stable=10, declining=3, inactive=0)
- login_frequency_days: weight 10 (None=5 neutral, <=7=10, <=30=7, <=60=4, >60=0)
- days_since_last_interaction: weight 10 (None=5 neutral, <=30=10, <=60=7, <=90=4, >90=0)
- invoice_payment_status: weight 10 (current=10, overdue_30=6, overdue_60=3, overdue_90_plus=0)
- support_sentiment: weight 10 (positive=10, neutral=7, negative=3, critical=0; also deduct min(open_ticket_count, 5) * 1)
- days_to_renewal: weight 10 (None=7 neutral, >180=10, >90=8, >60=6, >30=3, <=30=1)
- seats_utilization_rate: weight 5 (0.8-1.0=5 optimal, 0.5-0.8=3, <0.5=1, >1.0=4 over-used-upsell)
- stakeholder_engagement: weight 5 (high=5, medium=3, low=1)
- nps_score: weight 3 (None=2 neutral, 9-10=3, 7-8=2, 5-6=1, 0-4=0)
- escalation_count_90_days: weight 2 (0=2, 1=1, 2+=0)

**TAM correlation cap (apply AFTER computing raw score):**
- tam_health_rag == "RED": cap score at raw_score * 0.85
- tam_health_rag == "AMBER": cap score at raw_score * 0.95
- tam_health_rag == "GREEN" or None: no cap

**score() method:**
```python
def score(self, signals: CSMHealthSignals) -> CSMHealthScore:
```
1. Compute raw 0-100 score from weighted signals
2. Apply TAM cap if tam_health_rag is set
3. Determine rag: score >= green_threshold = "GREEN", >= amber_threshold = "AMBER", else "RED"
4. Determine churn_risk_level and churn_triggered_by:
   - contract_proximity trigger: rag in ("RED", "AMBER") and signals.days_to_renewal is not None and signals.days_to_renewal <= churn_window_days
   - behavioral trigger: usage_trend in ("declining", "inactive") and (login_frequency_days is None or login_frequency_days > 30)
   - if both triggers: churn_triggered_by = "both", churn_risk_level = "critical"
   - if contract_proximity only: churn_risk_level = "high" (or "critical" if rag == "RED")
   - if behavioral only: churn_risk_level = "high" if rag in ("RED", "AMBER") else "medium"
   - if neither: churn_risk_level = "low" if rag == "GREEN" else "medium"
5. Build signal_breakdown dict with per-signal contribution for explainability
6. Return CSMHealthScore(account_id extracted from context or "" — note: score() accepts account_id as second optional param)

Update score() signature:
```python
def score(self, signals: CSMHealthSignals, account_id: str = "") -> CSMHealthScore:
```

Add __all__ = ["CSMHealthScorer"]
  </action>
  <verify>
python -c "
from src.app.agents.customer_success.health_scorer import CSMHealthScorer
from src.app.agents.customer_success.schemas import CSMHealthSignals
scorer = CSMHealthScorer()
# Test GREEN
s = CSMHealthSignals(feature_adoption_rate=0.9, usage_trend='growing', invoice_payment_status='current', stakeholder_engagement='high', seats_utilization_rate=0.85)
r = scorer.score(s, 'acct-001')
assert r.rag == 'GREEN', f'Expected GREEN, got {r.rag}'
# Test RED churn
s2 = CSMHealthSignals(feature_adoption_rate=0.1, usage_trend='declining', login_frequency_days=90, invoice_payment_status='overdue_60', stakeholder_engagement='low', days_to_renewal=45, escalation_count_90_days=3)
r2 = scorer.score(s2, 'acct-002')
assert r2.rag == 'RED', f'Expected RED, got {r2.rag}'
assert r2.churn_triggered_by is not None
print('CSMHealthScorer OK')
"
  </verify>
  <done>CSMHealthScorer.score() produces CSMHealthScore with correct rag for healthy accounts (GREEN) and at-risk accounts (RED with churn_triggered_by set). TAM correlation cap reduces score for RED tam_health_rag inputs.</done>
</task>

<task type="auto">
  <name>Task 2: Create NotionCSMAdapter with full CRUD</name>
  <files>
    src/app/agents/customer_success/notion_adapter.py
  </files>
  <action>
Create src/app/agents/customer_success/notion_adapter.py. Pattern mirrors NotionTAMAdapter exactly (tenacity retry, AsyncClient injection, module-level block renderers).

**Module-level block renderers (pure functions, not adapter methods):**
- render_health_record_blocks(health_score: CSMHealthScore) -> list[dict]: Returns Notion blocks for health score display (paragraph, callout with RAG color)
- render_qbr_blocks(qbr: QBRContent) -> list[dict]: Returns Notion blocks for a full QBR page (H1 "Account Health Summary", H2 "ROI & Business Impact", H2 "Feature Adoption Scorecard", H2 "Expansion & Next Steps" — each with a paragraph narrative + bulleted list for metrics/items)
- render_expansion_blocks(opportunity: ExpansionOpportunity) -> list[dict]: Returns Notion blocks for expansion opportunity

**NotionCSMAdapter class:**

Constructor:
```python
def __init__(self, notion_client: AsyncClient) -> None:
```
Takes pre-authenticated AsyncClient (same pattern as NotionTAMAdapter, NotionPMAdapter, NotionBAAdapter).

**Async methods (all with @retry tenacity decorator — stop_after_attempt(3), wait_exponential(multiplier=1, min=1, max=10)):**

1. **get_account(account_id: str) -> dict[str, Any]:** Query Notion accounts database (NOTION_DATABASE_ID from settings), filter by account_id property. Return dict with BOTH "id" (Notion page_id) AND "account_id" keys for agent.py compatibility. Return empty dict if not found.

2. **query_all_accounts() -> list[dict[str, Any]]:** Query all pages in accounts database. Return list of account dicts (same format as get_account).

3. **update_health_score(page_id: str, score: float, rag: str) -> None:** Update Notion page properties: "CSM Health Score" (number), "CSM Health RAG" (select: GREEN/AMBER/RED), "CSM Last Scan" (date: now ISO format).

4. **create_qbr_page(qbr: QBRContent, account_name: str = "") -> str:** Create a new Notion page in NOTION_CSM_QBR_DATABASE_ID. Page title: "QBR: {account_name} — {qbr.period}". Properties: account_id (rich_text), period (rich_text), health_rag (select from health_summary context), generated_at (date), trigger (select). Add render_qbr_blocks(qbr) as page content (handle 100-block limit with append_block_children). Return created page_id.

5. **create_expansion_record(opportunity: ExpansionOpportunity) -> str:** Create page in NOTION_CSM_EXPANSION_DATABASE_ID. Properties: account_id, opportunity_type (select), estimated_arr_impact (number), confidence (select). Add render_expansion_blocks(opportunity) as content. Return page_id.

6. **get_health_record(account_id: str) -> dict[str, Any]:** Query NOTION_CSM_HEALTH_DATABASE_ID for latest health record for account. Return dict or empty dict.

Import settings from src.app.config. Use structlog logger. Graceful AsyncClient import (same try/except pattern as NotionTAMAdapter). Add __all__ = ["NotionCSMAdapter"].
  </action>
  <verify>
python -c "
from src.app.agents.customer_success.notion_adapter import NotionCSMAdapter, render_qbr_blocks
from src.app.agents.customer_success.schemas import QBRContent
from datetime import datetime, timezone
qbr = QBRContent(account_id='test', period='Q1 2026', health_summary='Healthy', roi_metrics={'time_saved': '10h/week'}, feature_adoption_scorecard={'billing': 0.9}, expansion_next_steps=['Add 5 seats'], trigger='quarterly', generated_at=datetime.now(timezone.utc))
blocks = render_qbr_blocks(qbr)
assert len(blocks) > 0
print(f'render_qbr_blocks produced {len(blocks)} blocks OK')
print('NotionCSMAdapter importable OK')
"
  </verify>
  <done>NotionCSMAdapter importable with 6 async methods. render_qbr_blocks() produces non-empty block list. All methods have tenacity retry decorators.</done>
</task>

</tasks>

<verification>
python -c "
from src.app.agents.customer_success.health_scorer import CSMHealthScorer
from src.app.agents.customer_success.notion_adapter import NotionCSMAdapter
from src.app.agents.customer_success.schemas import CSMHealthSignals
scorer = CSMHealthScorer()
signals = CSMHealthSignals(feature_adoption_rate=0.5, usage_trend='stable', invoice_payment_status='current', stakeholder_engagement='medium', seats_utilization_rate=0.7, tam_health_rag='RED')
result = scorer.score(signals, 'acct-test')
assert result.score <= signals.feature_adoption_rate * 100 * 0.85 + 50  # TAM RED cap applied
print('Plan 14-02 verification PASSED')
"
</verification>

<success_criteria>
- CSMHealthScorer.score() returns CSMHealthScore with correct rag band (GREEN/AMBER/RED)
- TAM RED cap reduces score to max 85% of raw computed value
- churn_triggered_by set when rag=RED/AMBER + days_to_renewal <= 60 (contract_proximity)
- NotionCSMAdapter has 6 async methods all with tenacity retry decorators
- get_account() returns dict with both "id" and "account_id" keys
- create_qbr_page() uses parent={"database_id": NOTION_CSM_QBR_DATABASE_ID}
</success_criteria>

<output>
After completion, create `.planning/phases/14-customer-success-agent/14-02-SUMMARY.md`
</output>
