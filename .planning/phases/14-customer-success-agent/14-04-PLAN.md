---
phase: 14-customer-success-agent
plan: 04
type: tdd
wave: 3
depends_on: ["14-01", "14-02"]
files_modified:
  - tests/test_csm_health_scorer.py
  - tests/test_csm_schemas.py
autonomous: true

must_haves:
  truths:
    - "CSMHealthScorer produces GREEN for high-adoption, growing, current-payment accounts"
    - "CSMHealthScorer produces RED for low-adoption, declining, overdue-90-plus accounts"
    - "TAM RED correlation cap reduces score to at most 85% of raw computed value"
    - "contract_proximity churn trigger fires when rag=RED and days_to_renewal <= 60"
    - "behavioral churn trigger fires when usage_trend=declining regardless of renewal date"
    - "CSMHealthScore.should_alert=True when rag=RED (model_validator verified)"
    - "CSMHealthSignals rejects invalid field values (nps_score > 10, seats_utilization_rate < 0)"
  artifacts:
    - path: "tests/test_csm_health_scorer.py"
      provides: "8+ tests for CSMHealthScorer deterministic scoring"
      contains: "class TestCSMHealthScorer"
    - path: "tests/test_csm_schemas.py"
      provides: "Pydantic model validation tests including model_validator"
      contains: "class TestCSMHealthScore"
  key_links:
    - from: "tests/test_csm_health_scorer.py"
      to: "src/app/agents/customer_success/health_scorer.py"
      via: "from src.app.agents.customer_success.health_scorer import CSMHealthScorer"
      pattern: "from src.app.agents.customer_success.health_scorer"
---

<objective>
TDD plan for CSMHealthScorer (deterministic scoring) and CSM Pydantic schema validation. These are pure Python with well-defined input/output contracts — ideal TDD candidates.

Purpose: The health scorer is the commercial decision engine. Tests prove the scoring algorithm is deterministic, the TAM correlation cap works, and churn triggers fire correctly.
Output: test_csm_health_scorer.py and test_csm_schemas.py with full RED/GREEN/REFACTOR cycles.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/14-customer-success-agent/14-01-SUMMARY.md
@.planning/phases/14-customer-success-agent/14-02-SUMMARY.md
@src/app/agents/customer_success/health_scorer.py
@src/app/agents/customer_success/schemas.py
</context>

<feature>
  <name>CSMHealthScorer deterministic scoring + schema validation</name>
  <files>
    tests/test_csm_health_scorer.py
    tests/test_csm_schemas.py
  </files>
  <behavior>
CSMHealthScorer scoring cases (all deterministic — no mocking needed, use real scorer):
- Healthy account (feature_adoption_rate=0.9, usage_trend=growing, invoice_payment_status=current, stakeholder_engagement=high, seats_utilization_rate=0.85) → rag=GREEN
- At-risk account (feature_adoption_rate=0.1, usage_trend=declining, invoice_payment_status=overdue_90_plus, stakeholder_engagement=low, login_frequency_days=90) → rag=RED
- TAM RED cap: same healthy account + tam_health_rag=RED → score <= (raw_without_cap * 0.85 + epsilon)
- TAM AMBER cap: same healthy account + tam_health_rag=AMBER → score <= (raw_without_cap * 0.95 + epsilon)
- Contract proximity trigger: rag=RED + days_to_renewal=45 → churn_triggered_by contains "contract_proximity"
- Behavioral trigger: usage_trend=declining + login_frequency_days=60 (AMBER/RED account) → churn_triggered_by contains "behavioral"
- Both triggers: rag=RED + days_to_renewal=30 + usage_trend=declining → churn_triggered_by="both", churn_risk_level="critical"
- Low churn: rag=GREEN, no renewal pressure → churn_risk_level="low"

Schema validation cases:
- CSMHealthScore(rag=RED) → should_alert=True (model_validator)
- CSMHealthScore(rag=GREEN, churn_risk_level=low) → should_alert=False
- CSMHealthScore(churn_risk_level=critical) → should_alert=True (model_validator)
- CSMHealthSignals(nps_score=11) → ValidationError (ge=0, le=10)
- CSMHealthSignals(seats_utilization_rate=-0.1) → ValidationError (ge=0.0)
- CSMHandoffRequest(task_type=unknown_type) → ValidationError (Literal)
- ExpansionOpportunity(opportunity_type=enterprise) → ValidationError (not in Literal)
  </behavior>
  <implementation>
Create tests following project convention (same file location as test_tam_handoff.py — in tests/ root, not tests/agents/). Use pytest, not unittest. Follow existing test file patterns in the codebase.

For health scorer tests: create real CSMHealthScorer instance (no mocking — it's pure Python, same pattern as TAM where real HealthScorer is used). Create CSMHealthSignals with only required fields set, use defaults for the rest.

For schema tests: use pytest.raises(ValidationError) for invalid inputs.

Run tests: cd into project root, run pytest tests/test_csm_health_scorer.py tests/test_csm_schemas.py -v
  </implementation>
</feature>

<output>
After completion, create `.planning/phases/14-customer-success-agent/14-04-SUMMARY.md`
</output>
