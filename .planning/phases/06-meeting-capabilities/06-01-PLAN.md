---
phase: 06-meeting-capabilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/meetings/__init__.py
  - src/app/meetings/schemas.py
  - src/app/meetings/models.py
  - src/app/meetings/repository.py
  - src/app/services/gsuite/calendar.py
  - src/app/config.py
  - alembic/versions/add_meeting_tables.py
  - pyproject.toml
autonomous: true
user_setup:
  - service: recall-ai
    why: "Meeting bot infrastructure for Google Meet joining, audio capture, Output Media"
    env_vars:
      - name: RECALL_AI_API_KEY
        source: "Recall.ai Dashboard -> API Keys"
      - name: RECALL_AI_REGION
        source: "Recall.ai Dashboard -> Settings (default: us-west-2)"
  - service: deepgram
    why: "Streaming speech-to-text for real-time meeting transcription"
    env_vars:
      - name: DEEPGRAM_API_KEY
        source: "Deepgram Console -> API Keys"
  - service: elevenlabs
    why: "Streaming text-to-speech for agent voice in meetings"
    env_vars:
      - name: ELEVENLABS_API_KEY
        source: "ElevenLabs Dashboard -> API Keys"
      - name: ELEVENLABS_VOICE_ID
        source: "ElevenLabs Dashboard -> Voices -> select voice -> Voice ID"
  - service: heygen
    why: "Animated avatar with lip-sync for visual meeting presence"
    env_vars:
      - name: HEYGEN_API_KEY
        source: "HeyGen Dashboard -> Settings -> API"
  - service: google-calendar
    why: "Meeting detection via Google Calendar API"
    env_vars: []
    dashboard_config:
      - task: "Add Calendar API scopes to domain-wide delegation"
        location: "Google Workspace Admin -> Security -> API Controls -> Domain-wide delegation -> Edit scopes for service account -> add https://www.googleapis.com/auth/calendar.readonly and https://www.googleapis.com/auth/calendar.events.readonly"

must_haves:
  truths:
    - "Meeting data (briefings, transcripts, minutes, participants) can be stored and retrieved per tenant"
    - "Google Calendar events with agent invites are detectable via Calendar API"
    - "All Phase 6 external service API keys are configurable via environment variables"
  artifacts:
    - path: "src/app/meetings/schemas.py"
      provides: "Pydantic schemas for Meeting, Briefing, Minutes, Participant, ActionItem, Decision, Transcript"
      min_lines: 120
    - path: "src/app/meetings/models.py"
      provides: "SQLAlchemy models for MeetingModel, BriefingModel, MinutesModel, TranscriptModel"
      min_lines: 80
    - path: "src/app/meetings/repository.py"
      provides: "MeetingRepository with CRUD for all meeting entities"
      exports: ["MeetingRepository"]
    - path: "src/app/services/gsuite/calendar.py"
      provides: "Google Calendar service extending GSuiteAuthManager pattern"
      exports: ["GoogleCalendarService", "CALENDAR_SCOPES"]
    - path: "alembic/versions/add_meeting_tables.py"
      provides: "Alembic migration for meetings, briefings, minutes, transcripts tables"
      contains: "create_table"
  key_links:
    - from: "src/app/meetings/models.py"
      to: "src/app/models/shared.py"
      via: "SharedBase import for SQLAlchemy model base"
      pattern: "from src\\.app\\.models"
    - from: "src/app/meetings/repository.py"
      to: "src/app/meetings/models.py"
      via: "SQLAlchemy model imports for queries"
      pattern: "from src\\.app\\.meetings\\.models import"
    - from: "src/app/services/gsuite/calendar.py"
      to: "src/app/services/gsuite/auth.py"
      via: "GSuiteAuthManager for credential management"
      pattern: "GSuiteAuthManager"
---

<objective>
Create the data foundation for Phase 6 Meeting Capabilities -- Pydantic schemas, SQLAlchemy models, Alembic migration, MeetingRepository, GoogleCalendarService, and all external service settings.

Purpose: Every subsequent Phase 6 plan depends on these data models, repository, and service foundations. This plan establishes the schema contract and data access patterns that all meeting subsystems (briefing, bot, realtime, minutes) will use.

Output: Meeting module skeleton with schemas, models, migration, repository, calendar service, and settings for all external APIs (Recall.ai, Deepgram, ElevenLabs, HeyGen).
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-meeting-capabilities/06-CONTEXT.md
@.planning/phases/06-meeting-capabilities/06-RESEARCH.md

@src/app/config.py
@src/app/models/shared.py
@src/app/services/gsuite/auth.py
@src/app/deals/repository.py
@src/app/deals/models.py
@alembic/versions/add_deal_management_tables.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Meeting Pydantic schemas, SQLAlchemy models, and Alembic migration</name>
  <files>
    src/app/meetings/__init__.py
    src/app/meetings/schemas.py
    src/app/meetings/models.py
    alembic/versions/add_meeting_tables.py
    src/app/config.py
    pyproject.toml
  </files>
  <action>
    1. Add new dependencies to pyproject.toml: `deepgram-sdk>=3.7.0` and `elevenlabs>=1.15.0`. (recall-ai and heygen are REST APIs, not pip packages.)

    2. Create `src/app/meetings/__init__.py` (empty module marker).

    3. Add these settings to `src/app/config.py` Settings class (after existing GOOGLE_ settings):
       - `RECALL_AI_API_KEY: str = ""`
       - `RECALL_AI_REGION: str = "us-west-2"`
       - `DEEPGRAM_API_KEY: str = ""`
       - `ELEVENLABS_API_KEY: str = ""`
       - `ELEVENLABS_VOICE_ID: str = ""`
       - `HEYGEN_API_KEY: str = ""`
       - `HEYGEN_AVATAR_ID: str = ""`  (default avatar, tenant-specific overrides later)
       - `MEETING_BOT_WEBAPP_URL: str = ""`  (URL where the Output Media webapp is hosted)

    4. Create `src/app/meetings/schemas.py` with Pydantic v2 schemas:
       - `ParticipantRole(str, Enum)`: INTERNAL, EXTERNAL, AGENT
       - `MeetingStatus(str, Enum)`: SCHEDULED, BRIEFING_GENERATED, BOT_JOINING, IN_PROGRESS, ENDED, MINUTES_GENERATED, DISTRIBUTED
       - `Participant(BaseModel)`: name, email, role (ParticipantRole), title (optional), company (optional)
       - `ActionItem(BaseModel)`: owner (str), action (str), due_date (str|None), context (str)
       - `Decision(BaseModel)`: decision (str), participants (list[str]), context (str)
       - `BriefingContent(BaseModel)`: account_context (str), attendee_profiles (list[dict]), objectives (list[str]), talk_tracks (list[str]), deal_context (str|None)
       - `Briefing(BaseModel)`: id (UUID), meeting_id (UUID), format (str: "structured"|"bullet"|"adaptive"), content (BriefingContent), generated_at (datetime)
       - `TranscriptEntry(BaseModel)`: speaker (str), text (str), timestamp_ms (int), is_final (bool)
       - `Transcript(BaseModel)`: id (UUID), meeting_id (UUID), entries (list[TranscriptEntry]), full_text (str)
       - `MeetingMinutes(BaseModel)`: id (UUID), meeting_id (UUID), executive_summary (str), key_topics (list[str]), action_items (list[ActionItem]), decisions (list[Decision]), follow_up_date (str|None), generated_at (datetime)
       - `Meeting(BaseModel)`: id (UUID), tenant_id (str), title (str), scheduled_start (datetime), scheduled_end (datetime), google_meet_url (str), google_event_id (str), status (MeetingStatus), participants (list[Participant]), bot_id (str|None), recording_url (str|None), created_at (datetime), updated_at (datetime)
       - `MeetingCreate(BaseModel)`: title, scheduled_start, scheduled_end, google_meet_url, google_event_id, participants
       - `MeetingBriefingRequest(BaseModel)`: meeting_id (UUID), format (str, default "structured")
       - `MinutesShareRequest(BaseModel)`: meeting_id (UUID), recipient_emails (list[str]), include_transcript (bool, default False)

    5. Create `src/app/meetings/models.py` with SQLAlchemy models following the deals/models.py pattern:
       - `MeetingModel`: id (UUID PK), tenant_id, title, scheduled_start, scheduled_end, google_meet_url, google_event_id (unique per tenant), status, participants_data (JSON), bot_id, recording_url, created_at, updated_at
       - `BriefingModel`: id (UUID PK), tenant_id, meeting_id (FK to MeetingModel), format, content_data (JSON), generated_at
       - `TranscriptModel`: id (UUID PK), tenant_id, meeting_id (FK to MeetingModel), entries_data (JSON), full_text (Text), created_at
       - `MinutesModel`: id (UUID PK), tenant_id, meeting_id (FK to MeetingModel), executive_summary (Text), key_topics_data (JSON), action_items_data (JSON), decisions_data (JSON), follow_up_date, generated_at, shared_externally (bool, default False)
       Use `__tablename__` with "meetings", "briefings", "transcripts", "meeting_minutes" names.
       Import base from `src.app.models.shared` following deals pattern.
       NO foreign key constraints per Phase 5 pattern (05-01 decision: application-level referential integrity).
       JSON columns use `model_dump()`/`model_validate()` for Pydantic round-tripping per 05-01 pattern.

    6. Create Alembic migration `alembic/versions/add_meeting_tables.py`:
       - Follow existing migration pattern from `add_deal_management_tables.py`
       - Use branch_labels=("tenant",) for tenant-scoped tables
       - Create tables: meetings, briefings, transcripts, meeting_minutes
       - All tables have tenant_id column (no FK -- RLS handles isolation)
       - Index on meetings(tenant_id, google_event_id) for calendar dedup
       - Index on meetings(tenant_id, status) for active meeting queries
       - Index on meetings(tenant_id, scheduled_start) for upcoming meeting queries
  </action>
  <verify>
    Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -c "from src.app.meetings.schemas import Meeting, Briefing, MeetingMinutes, Participant, ActionItem, Decision, Transcript; print('Schemas OK')"`
    Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -c "from src.app.meetings.models import MeetingModel, BriefingModel, TranscriptModel, MinutesModel; print('Models OK')"`
    Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -c "from src.app.config import get_settings; s = get_settings(); assert hasattr(s, 'RECALL_AI_API_KEY'); assert hasattr(s, 'DEEPGRAM_API_KEY'); assert hasattr(s, 'ELEVENLABS_API_KEY'); assert hasattr(s, 'HEYGEN_API_KEY'); print('Settings OK')"`
  </verify>
  <done>
    All meeting Pydantic schemas importable with correct fields. All SQLAlchemy models importable. Alembic migration file exists. Settings class has all Phase 6 external API key fields. deepgram-sdk and elevenlabs added to pyproject.toml.
  </done>
</task>

<task type="auto">
  <name>Task 2: MeetingRepository and GoogleCalendarService</name>
  <files>
    src/app/meetings/repository.py
    src/app/services/gsuite/calendar.py
    tests/test_meeting_foundation.py
  </files>
  <action>
    1. Create `src/app/meetings/repository.py` following the DealRepository pattern (05-01):
       - `MeetingRepository(session_factory)` with async CRUD methods:
         - `create_meeting(tenant_id, meeting_create) -> Meeting`
         - `get_meeting(tenant_id, meeting_id) -> Meeting | None`
         - `get_meeting_by_event_id(tenant_id, google_event_id) -> Meeting | None` (for calendar dedup)
         - `get_upcoming_meetings(tenant_id, from_time, to_time) -> list[Meeting]`
         - `update_meeting_status(tenant_id, meeting_id, status) -> Meeting`
         - `update_meeting_bot_id(tenant_id, meeting_id, bot_id) -> Meeting`
         - `save_briefing(tenant_id, briefing) -> Briefing`
         - `get_briefing(tenant_id, meeting_id, format) -> Briefing | None`
         - `save_transcript(tenant_id, transcript) -> Transcript`
         - `get_transcript(tenant_id, meeting_id) -> Transcript | None`
         - `append_transcript_entry(tenant_id, meeting_id, entry) -> None` (for real-time streaming)
         - `save_minutes(tenant_id, minutes) -> MeetingMinutes`
         - `get_minutes(tenant_id, meeting_id) -> MeetingMinutes | None`
         - `mark_minutes_shared(tenant_id, meeting_id) -> None`
       - Use `session_factory` callable pattern matching ConversationStateRepository (04-05) and DealRepository (05-01)
       - JSON columns use `model_dump()` for save and `model_validate()` for load per 05-01 pattern

    2. Create `src/app/services/gsuite/calendar.py`:
       - Import and extend the GSuiteAuthManager pattern from auth.py
       - Add `CALENDAR_SCOPES = ["https://www.googleapis.com/auth/calendar.readonly", "https://www.googleapis.com/auth/calendar.events.readonly"]`
       - `GoogleCalendarService(auth_manager: GSuiteAuthManager)`:
         - `get_calendar_service(user_email)` -- builds Calendar API v3 service with caching (same pattern as get_gmail_service)
         - `list_upcoming_events(agent_email, time_min, time_max) -> list[dict]` -- fetches events where agent is attendee
         - `get_event(agent_email, event_id) -> dict` -- fetches a single event by ID
         - `is_agent_invited(event, agent_email) -> bool` -- checks if agent email is in attendee list (explicit invite only, per CONTEXT.md)
         - `has_google_meet_link(event) -> bool` -- checks conferenceData.entryPoints for video type
         - `get_meet_url(event) -> str | None` -- extracts the Google Meet URL from event
         - `get_attendees(event) -> list[dict]` -- extracts attendee list with names and emails
       - Use `build("calendar", "v3", credentials=credentials)` for the service instance
       - The auth_manager is shared with Gmail/Chat -- Calendar uses domain-wide delegation with user_email

    3. Create `tests/test_meeting_foundation.py` with unit tests:
       - Test all Pydantic schemas construct correctly with valid data
       - Test schema validation rejects invalid data (missing required fields)
       - Test MeetingRepository CRUD methods using InMemoryMeetingRepository test double (same pattern as InMemoryDealRepository from 05-05)
       - Test GoogleCalendarService.is_agent_invited with mock event data
       - Test GoogleCalendarService.has_google_meet_link with mock conference data
       - Test GoogleCalendarService.get_meet_url extracts correct URL
       - Minimum 12 tests covering schemas, repository, and calendar service
  </action>
  <verify>
    Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -m pytest tests/test_meeting_foundation.py -v`
    All tests pass.
  </verify>
  <done>
    MeetingRepository provides full CRUD for meetings, briefings, transcripts, and minutes with session_factory pattern. GoogleCalendarService extends GSuiteAuthManager to detect agent meeting invites. Unit tests pass covering schemas, repository, and calendar service.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.app.meetings.schemas import *; from src.app.meetings.models import *; from src.app.meetings.repository import MeetingRepository; from src.app.services.gsuite.calendar import GoogleCalendarService; print('All imports OK')"` succeeds
2. `python -m pytest tests/test_meeting_foundation.py -v` -- all tests pass
3. Settings class has RECALL_AI_API_KEY, DEEPGRAM_API_KEY, ELEVENLABS_API_KEY, HEYGEN_API_KEY, MEETING_BOT_WEBAPP_URL
4. Alembic migration file exists with tenant-scoped tables
</verification>

<success_criteria>
Meeting data layer is complete -- schemas define the contract, models map to database, repository provides CRUD, Calendar service detects agent invites. All subsequent Phase 6 plans can import and use these foundations.
</success_criteria>

<output>
After completion, create `.planning/phases/06-meeting-capabilities/06-01-SUMMARY.md`
</output>
