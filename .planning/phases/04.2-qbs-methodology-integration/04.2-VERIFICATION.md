---
phase: 04.2-qbs-methodology-integration
verified: 2026-02-12T18:43:01Z
status: gaps_found
score: 4/5 must-haves verified
gaps:
  - truth: "Sales Agent employs QBS techniques to identify and expand contacts within accounts, building multi-threaded relationships"
    status: failed
    reason: "QBS components exist and are wired into SalesAgent class, but the SalesAgent instantiation in main.py does NOT pass qbs_engine or expansion_detector parameters ‚Äî they default to None, disabling all QBS functionality in the running application"
    artifacts:
      - path: "src/app/main.py"
        issue: "Lines 142-154 create SalesAgent without qbs_engine or expansion_detector parameters"
    missing:
      - "Phase 4.2 initialization block in main.py following Phase 4.1 pattern"
      - "QBSQuestionEngine instantiation with llm_service"
      - "AccountExpansionDetector instantiation with llm_service"
      - "Pass qbs_engine and expansion_detector to SalesAgent constructor"
      - "Store QBS components on app.state for potential API access"
---

# Phase 4.2: QBS Methodology Integration Verification Report

**Phase Goal:** The Sales Agent leverages Question Based Selling (QBS) methodology throughout all sales stages -- using pain funnel questions, impact questions, solution questions, and confirmation questions to guide conversations from outreach to closing and expand contacts within accounts

**Verified:** 2026-02-12T18:43:01Z
**Status:** GAPS FOUND
**Re-verification:** No ‚Äî initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Sales Agent uses pain funnel questions to uncover customer pain depth and urgency naturally within conversations | ‚úì VERIFIED | QBS engine in `src/app/agents/sales/qbs/engine.py` implements pain funnel question selection with rule-based fallback (lines 162-303). Pain depth tracking in `src/app/agents/sales/qbs/pain_tracker.py` manages state progression (lines 88-137). QBS methodology prompt in `src/app/agents/sales/qbs/prompts.py` includes pain funnel instructions (lines 36-39). **HOWEVER:** Not functional in running app due to main.py gap. |
| 2 | Sales Agent asks impact questions that help customers understand the business consequences of their pain points | ‚úì VERIFIED | QBS engine includes IMPACT question type (line 32 in schemas.py). Impact question selection logic exists in fallback_recommendation (engine.py lines 225-243). QBS methodology prompt includes impact question instructions (prompts.py lines 41-47). **HOWEVER:** Not functional in running app due to main.py gap. |
| 3 | Sales Agent guides customers through solution questions that connect their needs to product capabilities | ‚úì VERIFIED | QBS engine includes SOLUTION question type (line 33 in schemas.py). Solution question selection logic exists (engine.py lines 245-264). QBS methodology prompt includes solution question instructions (prompts.py lines 49-54). **HOWEVER:** Not functional in running app due to main.py gap. |
| 4 | Sales Agent uses confirmation questions to validate understanding and build commitment at each stage | ‚úì VERIFIED | QBS engine includes CONFIRMATION question type (line 34 in schemas.py). Confirmation question selection logic exists (engine.py lines 266-285). QBS methodology prompt includes confirmation question instructions (prompts.py lines 56-61). **HOWEVER:** Not functional in running app due to main.py gap. |
| 5 | Sales Agent employs QBS techniques to identify and expand contacts within accounts, building multi-threaded relationships | ‚úó FAILED | AccountExpansionDetector exists (`src/app/agents/sales/qbs/expansion.py`) with detect_expansion_triggers method (lines 49-127). Agent integration exists (`src/app/agents/sales/agent.py` lines 486-503). **BUT:** SalesAgent in main.py (lines 142-154) is instantiated WITHOUT qbs_engine or expansion_detector parameters ‚Äî both default to None, disabling all QBS functionality. |

**Score:** 4/5 truths verified structurally (1 failed functionally due to wiring gap)

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/app/agents/sales/qbs/schemas.py` | QBS Pydantic models for question types, pain depth, engagement signals | ‚úì SUBSTANTIVE | 253 lines, 8 enums/models, no stubs, exported via `__init__.py` |
| `src/app/agents/sales/qbs/prompts.py` | QBS methodology prompt templates and builders | ‚úì SUBSTANTIVE | 414 lines, 3 prompt constants, 3 builder functions, no stubs |
| `src/app/agents/sales/qbs/engine.py` | QBSQuestionEngine with analyze_and_recommend method | ‚úì SUBSTANTIVE | 419 lines, LLM-powered analysis with rule-based fallback, imported in agent.py |
| `src/app/agents/sales/qbs/pain_tracker.py` | PainDepthTracker with state management methods | ‚úì SUBSTANTIVE | 246 lines, static methods for load/save/update, back-off detection logic |
| `src/app/agents/sales/qbs/expansion.py` | AccountExpansionDetector with detect_expansion_triggers | ‚úì SUBSTANTIVE | 188 lines, LLM-powered extraction with urgency adjustment, used in agent.py |
| `src/app/agents/sales/prompts.py` | QBS methodology integration in system prompts | ‚úì SUBSTANTIVE | Lines 22, 309 import and inject QBS_METHODOLOGY_PROMPT, qbs_guidance parameter in build functions |
| `src/app/agents/sales/agent.py` | QBS engine integration in SalesAgent handlers | ‚úì WIRED | Lines 40-44 imports, lines 99-100 optional params, lines 227-273 _get_qbs_guidance, lines 301-310 email handler, lines 377-386 chat handler, lines 470-503 reply handler with pain tracking and expansion detection |
| `src/app/main.py` | QBS component initialization and wiring | ‚úó MISSING | NO Phase 4.2 initialization block exists. SalesAgent instantiated (lines 142-154) without qbs_engine or expansion_detector parameters. Components not initialized, not passed to agent, not stored on app.state. |
| `tests/test_qbs_integration.py` | Integration tests for QBS pipeline | ‚úì SUBSTANTIVE | 554 lines, 9 test classes, mocks QBS components for deterministic testing |

### Key Link Verification

| From | To | Via | Status | Details |
|------|-----|-----|--------|---------|
| SalesAgent | QBSQuestionEngine | qbs_engine.analyze_and_recommend | ‚ö†Ô∏è ORPHANED | SalesAgent code calls self._qbs_engine.analyze_and_recommend (agent.py line 473), BUT self._qbs_engine is None at runtime because main.py doesn't instantiate or pass QBSQuestionEngine |
| SalesAgent | PainDepthTracker | PainDepthTracker.load/save/update | ‚ö†Ô∏è ORPHANED | SalesAgent calls PainDepthTracker static methods (agent.py lines 477-481), BUT only executed when self._qbs_engine is not None (line 471), which is always False at runtime |
| SalesAgent | AccountExpansionDetector | expansion_detector.detect_expansion_triggers | ‚ö†Ô∏è ORPHANED | SalesAgent code calls self._expansion_detector.detect_expansion_triggers (agent.py line 490), BUT self._expansion_detector is None at runtime because main.py doesn't instantiate or pass AccountExpansionDetector |
| prompts.py | QBS_METHODOLOGY_PROMPT | import | ‚úì WIRED | Line 22 imports QBS_METHODOLOGY_PROMPT, line 309 injects into system prompt parts list |
| SalesAgent | build_qbs_prompt_section | via _get_qbs_guidance | ‚úì WIRED | Line 45 imports build_qbs_prompt_section, line 269 calls it in _get_qbs_guidance method |

### Requirements Coverage

Phase 4.2 was an INSERTED phase extending Sales Agent requirements. No explicit requirements in REQUIREMENTS.md, but extends SA-01 through SA-10 with QBS methodology.

All structural requirements satisfied:
- QBS question types implemented and selectable
- Pain depth tracking with state persistence
- Expansion detection with multi-threading recommendations
- Integration into agent handlers

**BLOCKED:** Functional requirement "Sales Agent uses QBS in production" blocked by main.py wiring gap.

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `src/app/main.py` | 142-154 | Missing optional parameters | üõë Blocker | QBS components exist but are never instantiated ‚Äî all QBS code is dead code at runtime |
| `src/app/main.py` | 166-218 | Phase 4.1 wiring present, Phase 4.2 wiring absent | üõë Blocker | Pattern established for Phase 4.1 (learning system), but not followed for Phase 4.2 |

### Human Verification Required

None required at this stage. The gap is clear and programmatically verifiable: QBS components are not instantiated in main.py.

Once gap is closed, human verification would include:
1. **Test QBS question generation:** Send test email, verify system prompt includes QBS methodology and dynamic guidance
2. **Test pain state persistence:** Process 2-3 customer replies, verify pain state accumulates in database metadata
3. **Test expansion detection:** Reply mentioning "my boss", verify expansion trigger saved in metadata

### Gaps Summary

**Critical Wiring Gap in main.py**

All QBS components are correctly implemented and wired into the SalesAgent class. The agent code is production-ready. However, **the SalesAgent is never given QBS components at runtime**.

In `src/app/main.py` lines 142-154, the SalesAgent is instantiated like this:

```python
sales_agent = SalesAgent(
    registration=sales_registration,
    llm_service=llm_service,
    gmail_service=gmail_service,
    chat_service=chat_service,
    rag_pipeline=rag_pipeline,
    conversation_store=conversation_store,
    session_manager=session_manager,
    state_repository=state_repo,
    qualification_extractor=qual_extractor,
    action_engine=action_engine,
    escalation_manager=escalation_mgr,
    # Missing: qbs_engine=qbs_engine,
    # Missing: expansion_detector=expansion_detector,
)
```

Because `qbs_engine` and `expansion_detector` parameters are not provided, they default to None (see agent.py lines 99-100). This means:

- `self._qbs_engine is None` ‚Üí line 471 check fails, pain tracking never runs
- `self._expansion_detector is None` ‚Üí line 486 check fails, expansion detection never runs
- QBS methodology prompt IS included (hardcoded), but dynamic guidance is never generated
- All QBS state management code is unreachable

**What's Missing:**

Following the Phase 4.1 pattern (main.py lines 166-218), Phase 4.2 needs:

```python
# ‚îÄ‚îÄ Phase 4.2: QBS Methodology Integration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
try:
    from src.app.agents.sales.qbs import QBSQuestionEngine, AccountExpansionDetector
    
    qbs_engine = QBSQuestionEngine(llm_service=llm_service)
    expansion_detector = AccountExpansionDetector(llm_service=llm_service)
    
    # Update SalesAgent instantiation with QBS components
    sales_agent = SalesAgent(
        # ... existing params ...
        qbs_engine=qbs_engine,
        expansion_detector=expansion_detector,
    )
    
    app.state.qbs_engine = qbs_engine
    app.state.expansion_detector = expansion_detector
    log.info("phase4_2.qbs_integration_initialized")
except Exception as exc:
    log.warning("phase4_2.qbs_integration_init_failed", error=str(exc))
```

This is a **single-point gap**: the components exist, the wiring exists, only the initialization is missing. Once added, all 5 success criteria will be functionally verified.

---

_Verified: 2026-02-12T18:43:01Z_
_Verifier: Claude (gsd-verifier)_
