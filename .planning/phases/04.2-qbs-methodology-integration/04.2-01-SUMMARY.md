---
phase: 04.2-qbs-methodology-integration
plan: 01
subsystem: sales-agent
tags: [qbs, pydantic, prompts, pain-funnel, engagement-signals, expansion-detection, methodology-blending]

# Dependency graph
requires:
  - phase: 04-sales-agent-core
    provides: "Sales Agent schemas (ConversationState, QualificationState, DealStage), prompts (Voss methodology, persona configs), and qualification extraction patterns"
provides:
  - "QBS Pydantic models: QBSQuestionType, PainDepthLevel, EngagementSignal, QBSQuestionRecommendation, PainTopic, PainFunnelState, ExpansionTrigger, ExpansionRecommendation"
  - "QBS prompt templates: QBS_METHODOLOGY_PROMPT, QBS_ANALYSIS_SYSTEM_PROMPT, EXPANSION_DETECTION_PROMPT"
  - "QBS prompt builders: build_qbs_analysis_prompt, build_qbs_prompt_section, build_expansion_detection_prompt"
affects:
  - "04.2-02 (QBS Question Engine + Pain Tracker depend on schemas and prompts)"
  - "04.2-03 (Expansion Detector + Agent Integration depend on schemas, prompts, and builder functions)"

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "QBS submodule under src/app/agents/sales/qbs/ with schemas.py and prompts.py"
    - "Blended triple pattern: question_type + meddic_bant_target + voss_delivery in QBSQuestionRecommendation"
    - "Pain funnel state tracking via PainFunnelState model (metadata-stored, no DB migration)"
    - "Dynamic prompt section injection via build_qbs_prompt_section (string section, not messages list)"

key-files:
  created:
    - "src/app/agents/sales/qbs/__init__.py"
    - "src/app/agents/sales/qbs/schemas.py"
    - "src/app/agents/sales/qbs/prompts.py"
    - "tests/test_qbs_schemas.py"
  modified: []

key-decisions:
  - "EngagementSignal.EMOTIONAL_LANGUAGE value is 'emotional_language' (not 'emotional' as in RESEARCH.md example) for clarity"
  - "QBS prompt section is a string (not messages list) because it is injected INTO the system prompt, not sent as separate messages"
  - "Expansion detection prompt appends known contacts to system message rather than using a separate parameter format"
  - "build_qbs_prompt_section shows at most 3 pain topics and 3 revisit-later items to prevent prompt bloat"

patterns-established:
  - "QBS submodule pattern: schemas.py for types, prompts.py for templates and builders, __init__.py for exports"
  - "Blended triple: every QBS recommendation captures question_type + meddic_bant_target + voss_delivery"
  - "Pain funnel state: PainFunnelState with max 10 topics, probe count tracking, resistance detection, revisit-later list"
  - "Prompt section builder pattern: returns string for injection into system prompt (contrast with messages list builders for instructor calls)"

# Metrics
duration: 5min
completed: 2026-02-12
---

# Phase 4.2 Plan 01: QBS Schemas & Prompts Summary

**QBS type system (8 Pydantic models) + methodology prompts (3 templates, 3 builders) with blended triple pattern for question_type + MEDDIC/BANT target + Voss delivery**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-12T18:14:55Z
- **Completed:** 2026-02-12T18:20:19Z
- **Tasks:** 3
- **Files created:** 4

## Accomplishments

- 8 QBS Pydantic models covering question types, pain depth, engagement signals, recommendations, pain funnel state, and expansion triggers
- 3 prompt constants encoding elite salesperson principles, signal-driven analysis, and expansion detection with anti-interrogation and give-value-first rules
- 3 builder functions producing instructor-compatible messages lists and dynamic prompt sections for system prompt injection
- 51 unit tests validating all schemas, prompt content, and builder function output

## Task Commits

Each task was committed atomically:

1. **Task 1: QBS Pydantic schemas** - `2b8efbe` (feat)
2. **Task 2: QBS prompt templates and section builders** - `77913ee` (feat)
3. **Task 3: Unit tests for QBS schemas and prompts** - `af3611a` (test)

## Files Created/Modified

- `src/app/agents/sales/qbs/__init__.py` - Module exports for all 8 QBS schema classes
- `src/app/agents/sales/qbs/schemas.py` - QBSQuestionType, PainDepthLevel, EngagementSignal enums; QBSQuestionRecommendation, PainTopic, PainFunnelState, ExpansionTrigger, ExpansionRecommendation models
- `src/app/agents/sales/qbs/prompts.py` - QBS_METHODOLOGY_PROMPT, QBS_ANALYSIS_SYSTEM_PROMPT, EXPANSION_DETECTION_PROMPT constants; build_qbs_analysis_prompt, build_qbs_prompt_section, build_expansion_detection_prompt functions
- `tests/test_qbs_schemas.py` - 51 unit tests covering schema construction, enum values, prompt content, and builder function output

## Decisions Made

- **EngagementSignal.EMOTIONAL_LANGUAGE value:** Used `"emotional_language"` instead of `"emotional"` (as shown in RESEARCH.md example) for unambiguous naming that won't collide with PainDepthLevel.EMOTIONAL
- **Prompt section as string:** `build_qbs_prompt_section` returns a plain string for injection into the system prompt, while `build_qbs_analysis_prompt` and `build_expansion_detection_prompt` return messages lists for instructor calls -- two distinct builder patterns for two distinct use cases
- **Known contacts in system message:** `build_expansion_detection_prompt` appends the existing contacts list directly to the system message content rather than using a structured parameter, keeping the messages list at exactly 2 items (system + user)
- **Pain topic display limit:** `build_qbs_prompt_section` shows at most 3 pain topics and 3 revisit-later items in the prompt section to prevent context window bloat in long conversations

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- QBS schemas and prompts are ready for Plan 02 (QBS Question Engine + Pain Tracker) to build on
- QBSQuestionRecommendation is the primary instructor response_model for the QBS engine
- PainFunnelState is the state model for the Pain Tracker
- Prompt builders are ready for integration into agent.py prompt composition
- All 662 tests pass (611 existing + 51 new QBS tests)

---
*Phase: 04.2-qbs-methodology-integration*
*Completed: 2026-02-12*
