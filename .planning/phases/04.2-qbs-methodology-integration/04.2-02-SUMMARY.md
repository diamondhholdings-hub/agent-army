---
phase: 04.2-qbs-methodology-integration
plan: 02
subsystem: sales-agent
tags: [qbs, engine, pain-tracker, expansion-detector, instructor, litellm, fail-open, signal-analysis]

# Dependency graph
requires:
  - phase: 04.2-01
    provides: "QBS Pydantic schemas (QBSQuestionRecommendation, PainFunnelState, ExpansionTrigger, etc.) and prompt builders (build_qbs_analysis_prompt, build_expansion_detection_prompt)"
  - phase: 04-sales-agent-core
    provides: "ConversationState, QualificationState, QualificationExtractor pattern (instructor + litellm, fail-open, model resolution)"
provides:
  - "QBSQuestionEngine: adaptive signal-driven question selection with LLM analysis and rule-based fallback"
  - "PainDepthTracker: pain funnel state management in ConversationState.metadata with max 10 topics and back-off detection"
  - "AccountExpansionDetector: multi-threading opportunity detection with urgency adjustment for early interactions"
affects:
  - "04.2-03 (Agent integration: wiring QBS engine, pain tracker, and expansion detector into agent.py invoke flow)"

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "QBS engine uses 'fast' model for low-latency signal analysis (~500ms target)"
    - "Rule-based fallback per pain depth level matching NextActionEngine pattern"
    - "Pain state persisted in ConversationState.metadata['qbs']['pain_state'] (no DB migration)"
    - "Expansion state in metadata['qbs']['expansion'] with dedup and 20-entry cap"
    - "Urgency adjustment: interaction_count < 3 overrides 'immediate' to 'next_conversation'"

key-files:
  created:
    - "src/app/agents/sales/qbs/engine.py"
    - "src/app/agents/sales/qbs/pain_tracker.py"
    - "src/app/agents/sales/qbs/expansion.py"
    - "tests/test_qbs_engine.py"
  modified:
    - "src/app/agents/sales/qbs/__init__.py"

key-decisions:
  - "QBS engine uses 'fast' model (not 'reasoning') per RESEARCH.md Pitfall 5 for low-latency signal analysis"
  - "Pain depth only advances forward (NOT_EXPLORED -> SURFACE -> BUSINESS_IMPACT -> EMOTIONAL), never regresses"
  - "Back-off threshold: 3+ probes on same topic without self-elaboration or emotional recognition"
  - "Expansion urgency override: interaction_count < 3 prevents premature 'immediate' expansion requests"
  - "Max 10 pain topics with oldest-by-last_probed_at eviction per RESEARCH.md Pitfall 6"
  - "Expansion state capped at 20 entries, deduplicated by mentioned_name_or_role"
  - "All three components fail-open on LLM errors: engine returns rule-based fallback, expansion returns empty list"

patterns-established:
  - "Static method pattern for PainDepthTracker (no instance state, caller handles persistence)"
  - "Probe tracking key format: '{question_type}:{meddic_bant_target}' for topic change detection"
  - "Depth comparison via _DEPTH_ORDER list index for clean ordering semantics"

# Metrics
duration: 6min
completed: 2026-02-12
---

# Phase 4.2 Plan 02: QBS Engine, Pain Tracker & Expansion Detector Summary

**Three QBS service classes: signal-driven question engine with rule-based fallback, pain funnel state tracker with max 10 topics and back-off detection, expansion detector with urgency adjustment for early interactions**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-12T18:23:42Z
- **Completed:** 2026-02-12T18:29:15Z
- **Tasks:** 3
- **Files created:** 4
- **Files modified:** 1

## Accomplishments

- QBSQuestionEngine with `analyze_and_recommend()` using instructor + LiteLLM for signal analysis across three sensing modes (information gap, engagement, natural flow)
- Rule-based fallback covering all 5 pain depth levels with appropriate question types, targets, and Voss delivery techniques
- PainDepthTracker with static methods for load/save/update in ConversationState.metadata, max 10 topic enforcement, and back-off detection
- AccountExpansionDetector with LLM-powered contact mention extraction, urgency adjustment for early interactions, and state management with deduplication
- 43 unit tests covering fallback logic, state management, back-off rules, expansion dedup, and model resolution

## Task Commits

Each task was committed atomically:

1. **Task 1: QBS Question Engine** - `dbb19e8` (feat)
2. **Task 2: Pain Tracker + Expansion Detector** - `2fbb7ea` (feat)
3. **Task 3: Unit tests** - `ebcf0f9` (test)

## Files Created/Modified

- `src/app/agents/sales/qbs/engine.py` - QBSQuestionEngine class with analyze_and_recommend(), rule-based fallback, qualification gap analysis, pain state loading, pain summary building
- `src/app/agents/sales/qbs/pain_tracker.py` - PainDepthTracker with load/save/update_from_recommendation/add_pain_topic/should_back_off static methods
- `src/app/agents/sales/qbs/expansion.py` - AccountExpansionDetector with detect_expansion_triggers() and save_expansion_state()
- `src/app/agents/sales/qbs/__init__.py` - Added QBSQuestionEngine, PainDepthTracker, AccountExpansionDetector exports
- `tests/test_qbs_engine.py` - 43 unit tests across 11 test classes

## Decisions Made

- **Fast model for QBS engine:** Uses "fast" model (not "reasoning") per RESEARCH.md Pitfall 5 for low-latency signal analysis (~500ms target). QualificationExtractor uses "reasoning" for deeper analysis -- these serve different purposes.
- **Forward-only depth progression:** Pain depth level only advances forward (NOT_EXPLORED -> SURFACE -> BUSINESS_IMPACT -> EMOTIONAL). This prevents state corruption from occasional LLM misclassification.
- **Back-off threshold at 3 probes:** `should_back_off()` triggers after 3 probes on the same topic without customer self-elaboration or emotional recognition. Resistance detection is an immediate trigger regardless of probe count.
- **Urgency override for early interactions:** When `interaction_count < 3`, any "immediate" expansion urgency is overridden to "next_conversation" per RESEARCH.md Pitfall 4 (don't expand before trust is established).
- **Max 10 pain topics with LRU eviction:** Evicts the topic with the oldest `last_probed_at` when the limit is exceeded. This prevents unbounded state growth in long-running conversations.
- **Expansion state cap at 20 entries:** Deduplicates by `mentioned_name_or_role` and keeps only the most recent 20 entries to bound metadata size.
- **All components fail-open:** QBS engine returns rule-based fallback, expansion detector returns empty list. Consistent with the project-wide fail-open pattern for LLM errors.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All three QBS service classes are ready for Plan 03 (Agent Integration) to wire into the agent.py invoke flow
- QBSQuestionEngine.analyze_and_recommend() produces QBSQuestionRecommendation for prompt section building
- PainDepthTracker.load/save manages state across invocations via ConversationState.metadata
- AccountExpansionDetector.detect_expansion_triggers() produces ExpansionTrigger list for prompt section
- All 705 tests pass (662 existing + 43 new QBS engine tests)

---
*Phase: 04.2-qbs-methodology-integration*
*Completed: 2026-02-12*
