---
phase: 04.2-qbs-methodology-integration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [src/app/main.py]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "QBSQuestionEngine is instantiated at application startup"
    - "AccountExpansionDetector is instantiated at application startup"
    - "SalesAgent receives qbs_engine and expansion_detector parameters at construction"
    - "QBS components are stored on app.state for API access"
    - "QBS initialization failure does not prevent application startup"
  artifacts:
    - path: "src/app/main.py"
      provides: "Phase 4.2 QBS component initialization block"
      contains: "QBSQuestionEngine"
  key_links:
    - from: "src/app/main.py"
      to: "src/app/agents/sales/qbs/__init__.py"
      via: "import QBSQuestionEngine, AccountExpansionDetector"
      pattern: "from src\\.app\\.agents\\.sales\\.qbs import"
    - from: "src/app/main.py"
      to: "SalesAgent constructor"
      via: "qbs_engine and expansion_detector kwargs"
      pattern: "qbs_engine=qbs_engine.*expansion_detector=expansion_detector"
---

<objective>
Wire QBS components into SalesAgent instantiation in main.py, closing the single gap that prevents all QBS functionality from running in the live application.

Purpose: All QBS code (engine, pain tracker, expansion detector) is correctly implemented and wired into SalesAgent but the SalesAgent is instantiated in main.py without these parameters, making all QBS functionality dead code at runtime.

Output: Updated src/app/main.py with Phase 4.2 initialization that instantiates QBSQuestionEngine and AccountExpansionDetector, passes them to SalesAgent, and stores them on app.state.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.2-qbs-methodology-integration/04.2-03-SUMMARY.md
@.planning/phases/04.2-qbs-methodology-integration/04.2-VERIFICATION.md
@src/app/main.py
@src/app/agents/sales/qbs/__init__.py
@src/app/agents/sales/agent.py (lines 86-101 for constructor signature)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QBS component initialization and wire into SalesAgent in main.py</name>
  <files>src/app/main.py</files>
  <action>
In the Phase 4 Sales Agent initialization block in `src/app/main.py` (the `try` block starting at line 99), make two changes:

**Change 1: Import QBS components** (after the existing Phase 4 imports, around line 106):

Add after the `from src.app.core.database import get_tenant_session` line:
```python
from src.app.agents.sales.qbs import QBSQuestionEngine, AccountExpansionDetector
```

**Change 2: Instantiate QBS components and pass to SalesAgent** (between the escalation_mgr creation at line ~140 and the SalesAgent instantiation at line 142):

Add after `escalation_mgr = EscalationManager(...)`:
```python
# Phase 4.2: QBS methodology components
qbs_engine = QBSQuestionEngine(llm_service=llm_service)
expansion_detector = AccountExpansionDetector(llm_service=llm_service)
```

**Change 3: Update SalesAgent constructor call** (lines 142-154):

Add `qbs_engine=qbs_engine` and `expansion_detector=expansion_detector` as the last two keyword arguments to SalesAgent(), before the closing paren:
```python
sales_agent = SalesAgent(
    registration=sales_registration,
    llm_service=llm_service,
    gmail_service=gmail_service,
    chat_service=chat_service,
    rag_pipeline=rag_pipeline,
    conversation_store=conversation_store,
    session_manager=session_manager,
    state_repository=state_repo,
    qualification_extractor=qual_extractor,
    action_engine=action_engine,
    escalation_manager=escalation_mgr,
    qbs_engine=qbs_engine,
    expansion_detector=expansion_detector,
)
```

**Change 4: Store QBS components on app.state** (after `app.state.sales_agent = sales_agent` on line 161, before the log.info):

Add:
```python
app.state.qbs_engine = qbs_engine
app.state.expansion_detector = expansion_detector
```

Update the log line to:
```python
log.info("phase4.sales_agent_initialized", qbs_enabled=True)
```

**Important notes:**
- Keep all QBS initialization INSIDE the existing Phase 4 try/except block (not a separate block). This matches the single-agent initialization pattern: if SalesAgent init fails, all its components should be in the same failure scope.
- The QBSQuestionEngine and AccountExpansionDetector constructors each take a single `llm_service` parameter (typed as `object`).
- The SalesAgent constructor accepts `qbs_engine: QBSQuestionEngine | None = None` and `expansion_detector: AccountExpansionDetector | None = None` -- both are optional, backward compatible.
- Do NOT add a separate Phase 4.2 try/except block. The components are part of SalesAgent initialization.
  </action>
  <verify>
Run the full test suite to confirm no regressions:
```bash
cd "/Users/RAZER/Documents/projects/sales army" && python -m pytest tests/ -x -q --tb=short 2>&1 | tail -20
```

Additionally, verify the wiring with a targeted grep:
```bash
grep -n "qbs_engine\|expansion_detector\|QBSQuestionEngine\|AccountExpansionDetector" src/app/main.py
```

Expected: Both QBS imports, instantiations, SalesAgent kwargs, and app.state assignments visible in main.py. All 714+ tests pass.
  </verify>
  <done>
SalesAgent in main.py is constructed with qbs_engine and expansion_detector parameters. QBSQuestionEngine and AccountExpansionDetector are instantiated with llm_service and stored on app.state. All QBS functionality is now active at runtime. Tests pass with zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `grep -n "QBSQuestionEngine\|AccountExpansionDetector" src/app/main.py` shows imports and instantiation
2. `grep -n "qbs_engine=qbs_engine\|expansion_detector=expansion_detector" src/app/main.py` shows SalesAgent kwargs
3. `grep -n "app.state.qbs_engine\|app.state.expansion_detector" src/app/main.py` shows app.state storage
4. `python -m pytest tests/ -x -q --tb=short` passes all tests (714+)
5. The Phase 4 try/except block contains all QBS initialization (no separate block)
</verification>

<success_criteria>
- QBSQuestionEngine and AccountExpansionDetector imported from src.app.agents.sales.qbs
- Both instantiated with llm_service=llm_service
- Both passed to SalesAgent constructor as keyword arguments
- Both stored on app.state for potential API access
- All existing tests pass with zero regressions
- Phase 4.2 VERIFICATION.md truth #5 now passes: "Sales Agent employs QBS techniques to identify and expand contacts within accounts, building multi-threaded relationships"
</success_criteria>

<output>
After completion, create `.planning/phases/04.2-qbs-methodology-integration/04.2-04-SUMMARY.md`
</output>
