---
phase: 07-intelligence-autonomy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/intelligence/persona/geographic.py
  - src/app/intelligence/persona/cloning.py
  - src/app/intelligence/persona/persona_builder.py
  - tests/test_persona.py
autonomous: true

must_haves:
  truths:
    - "GeographicAdapter produces prompt sections for APAC, EMEA, and Americas regions"
    - "AgentCloneManager creates, retrieves, and deactivates persona clones"
    - "PersonaBuilder generates persona config from guided dimensions and produces preview samples"
    - "Clone persona affects communication style only, never overrides sales methodology"
  artifacts:
    - path: "src/app/intelligence/persona/geographic.py"
      provides: "GeographicAdapter extending RegionalNuances into prompt sections"
      contains: "class GeographicAdapter"
    - path: "src/app/intelligence/persona/cloning.py"
      provides: "AgentCloneManager for CRUD and prompt section generation"
      contains: "class AgentCloneManager"
    - path: "src/app/intelligence/persona/persona_builder.py"
      provides: "PersonaBuilder with guided wizard and preview generation"
      contains: "class PersonaBuilder"
  key_links:
    - from: "src/app/intelligence/persona/geographic.py"
      to: "src/knowledge/regional/nuances.py"
      via: "RegionalNuances composition"
      pattern: "RegionalNuances"
    - from: "src/app/intelligence/persona/cloning.py"
      to: "src/app/intelligence/persona/schemas.py"
      via: "PersonaConfig schema"
      pattern: "from src.app.intelligence.persona.schemas import PersonaConfig"
---

<objective>
Build the geographic adaptation and agent cloning system. GeographicAdapter extends the existing RegionalNuances into LLM-ready prompt sections. AgentCloneManager handles creating and managing persona-differentiated agent clones. PersonaBuilder provides guided persona creation with preview capability.

Purpose: Agent cloning allows each sales rep to have a personalized agent. Geographic adaptation ensures culturally appropriate communication. Both are configuration-driven and independent of the other sub-systems.

Output: Three service classes in `src/app/intelligence/persona/` with comprehensive tests.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-intelligence-autonomy/07-CONTEXT.md
@.planning/phases/07-intelligence-autonomy/07-RESEARCH.md
@src/knowledge/regional/nuances.py
@src/app/agents/sales/prompts.py
@src/app/intelligence/persona/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: GeographicAdapter and AgentCloneManager</name>
  <files>
    src/app/intelligence/persona/geographic.py
    src/app/intelligence/persona/cloning.py
  </files>
  <action>
    **geographic.py:** Create `GeographicAdapter` that extends the existing `RegionalNuances` (from `src/knowledge/regional/nuances.py`) into prompt-ready geographic communication guidance.

    - Constructor takes no required args; internally creates `RegionalNuances()` instance.
    - `build_geographic_prompt_section(region: str) -> str`: Generates a prompt section for geographic communication adaptation. Uses `self._nuances.get_regional_context(region)` to get region data. Returns a prompt section like:
      ```
      ## Geographic Communication Adaptation ({region_name})
      Communication style: {communication_style}
      Cultural awareness:
      - {note_1}
      - {note_2}

      IMPORTANT: Adapt your TONE and COMMUNICATION STYLE per the above guidance.
      Do NOT change the sales methodology, qualification process, or deal progression approach.
      The core methodology is consistent across all regions.
      ```
      Returns empty string for unknown regions (not an error -- graceful fallback).
    - `get_supported_regions() -> list[str]`: Returns list of supported region codes.
    - `get_geographic_profile(region: str) -> GeographicProfile`: Returns a structured profile from RegionalNuances data (formality_default based on region: APAC=0.7, EMEA=0.6, Americas=0.4).

    **cloning.py:** Create `AgentCloneManager` for persona-differentiated agent clones.

    - Constructor takes `repository` (IntelligenceRepository or compatible interface) and optional `llm_service` (for preview generation).
    - `async create_clone(tenant_id: str, config: PersonaConfig) -> CloneConfig`: Validates persona dimensions (all 0-1), stores via repository, returns CloneConfig. Raises ValueError for invalid dimensions.
    - `async get_clone(tenant_id: str, clone_id: str) -> CloneConfig | None`: Retrieves from repository.
    - `async list_clones(tenant_id: str) -> list[CloneConfig]`: Lists all active clones for tenant.
    - `async deactivate_clone(tenant_id: str, clone_id: str) -> bool`: Soft-deactivates (is_active=False).
    - `build_clone_prompt_section(config: PersonaConfig) -> str`: Generates a prompt section from persona config for injection into the SalesAgent system prompt. Maps dimension values to descriptive text:
      - formality > 0.7: "formal and professional" | < 0.3: "casual and approachable" | else: "balanced"
      - aggressiveness > 0.7: "direct and results-focused" | < 0.3: "consultative and patient" | else: "balanced"
      - technical_depth > 0.7: "deep technical detail" | < 0.3: "business-level language" | else: "moderate technical detail"
      - relationship_focus > 0.7: "relationship-first, invest in rapport" | < 0.3: "efficient, get to business quickly" | else: "balanced rapport and business"
      Include custom_instructions if present. Include communication_examples if any exist (max 3).
      CRITICAL: Section must include the disclaimer: "These style preferences do NOT override the core sales methodology (BANT, MEDDIC, QBS). Apply them to HOW you communicate, not WHAT you do."
    - `async update_clone_metrics(tenant_id: str, clone_id: str, metrics: PerformanceMetrics) -> bool`: Updates the performance_metrics JSON column.

    Both classes follow the existing service pattern: structlog logging, `from __future__ import annotations`, error handling with try/except and logger.warning for non-critical failures.
  </action>
  <verify>Run `python -c "from src.app.intelligence.persona.geographic import GeographicAdapter; from src.app.intelligence.persona.cloning import AgentCloneManager; print('OK')"` -- imports succeed.</verify>
  <done>GeographicAdapter produces prompt sections for all 3 regions. AgentCloneManager handles CRUD and prompt generation for persona clones.</done>
</task>

<task type="auto">
  <name>Task 2: PersonaBuilder and comprehensive tests</name>
  <files>
    src/app/intelligence/persona/persona_builder.py
    tests/test_persona.py
  </files>
  <action>
    **persona_builder.py:** Create `PersonaBuilder` -- a guided persona creation service that generates PersonaConfig from user inputs and produces preview samples.

    - Constructor takes optional `llm_service` and `geographic_adapter: GeographicAdapter`.
    - `get_dimension_options() -> dict`: Returns a dictionary describing each dimension with labels and descriptions for the guided builder UI:
      ```python
      {
          "formality": {"label": "Communication Formality", "low": "Casual and friendly", "high": "Formal and professional", "default": 0.5},
          "aggressiveness": {"label": "Sales Approach", "low": "Consultative and patient", "high": "Direct and results-focused", "default": 0.5},
          "technical_depth": {"label": "Technical Depth", "low": "Business-level language", "high": "Deep technical detail", "default": 0.5},
          "relationship_focus": {"label": "Relationship Style", "low": "Transaction-focused, efficient", "high": "Relationship-first, invest in rapport", "default": 0.5},
      }
      ```
    - `build_persona(clone_name: str, owner_id: str, dimensions: PersonaDimensions, region: str = "americas", examples: list[str] | None = None, instructions: str = "") -> PersonaConfig`: Validates inputs, creates a PersonaConfig. Generates a UUID clone_id. Applies geographic defaults if region-specific defaults exist (e.g., APAC gets higher formality default).
    - `async generate_preview(config: PersonaConfig) -> PersonaPreview`: Generates sample email and chat messages using the persona config. If llm_service is available, uses LLM with model='fast' to generate realistic samples. If llm_service is None, generates rule-based samples using dimension thresholds (e.g., high formality = "Dear Mr./Ms.", low formality = "Hey!"). Returns PersonaPreview with sample_email, sample_chat, and persona_summary (text description of the persona).
    - `validate_persona(config: PersonaConfig) -> list[str]`: Returns list of validation warnings (empty = valid). Checks: dimensions in range, clone_name non-empty, region supported. Does NOT raise -- returns warnings for UI display.

    **tests/test_persona.py:** Comprehensive tests for all 3 services:

    1. GeographicAdapter tests (5+):
       - `test_build_prompt_section_apac` -- returns non-empty section with APAC content
       - `test_build_prompt_section_emea` -- returns EMEA section
       - `test_build_prompt_section_americas` -- returns Americas section
       - `test_build_prompt_section_unknown_region` -- returns empty string
       - `test_prompt_section_contains_methodology_disclaimer` -- section contains "Do NOT change the sales methodology"
       - `test_get_geographic_profile` -- returns valid GeographicProfile

    2. AgentCloneManager tests (5+):
       - `test_build_clone_prompt_section_formal` -- formality=0.9 produces "formal and professional"
       - `test_build_clone_prompt_section_casual` -- formality=0.1 produces "casual and approachable"
       - `test_build_clone_prompt_section_balanced` -- formality=0.5 produces "balanced"
       - `test_prompt_section_includes_methodology_disclaimer` -- contains "do NOT override"
       - `test_build_clone_prompt_with_custom_instructions` -- custom_instructions appear in output
       - `test_build_clone_prompt_with_examples` -- communication_examples included (max 3)

    3. PersonaBuilder tests (5+):
       - `test_get_dimension_options_all_keys` -- returns all 4 dimensions
       - `test_build_persona_default_region` -- creates valid PersonaConfig
       - `test_build_persona_apac_defaults` -- APAC gets higher formality
       - `test_validate_persona_valid` -- empty warnings for valid config
       - `test_validate_persona_empty_name` -- warns on empty name
       - `test_generate_preview_no_llm` -- rule-based fallback generates sample email and chat

    Use pytest with no database dependency (all in-memory). Use test doubles for repository.
  </action>
  <verify>Run `python -m pytest tests/test_persona.py -v` -- all tests pass.</verify>
  <done>PersonaBuilder creates personas with guided dimensions and preview generation. 15+ tests pass covering GeographicAdapter, AgentCloneManager, and PersonaBuilder.</done>
</task>

</tasks>

<verification>
- `python -m pytest tests/test_persona.py -v` -- all tests pass
- Geographic prompt sections include methodology disclaimer
- Clone prompt sections include methodology non-override disclaimer
- PersonaBuilder generates preview without LLM (rule-based fallback)
</verification>

<success_criteria>
- GeographicAdapter works for APAC, EMEA, Americas (plus graceful unknown region handling)
- AgentCloneManager generates prompt sections that preserve methodology integrity
- PersonaBuilder provides guided creation with validation and preview
- 15+ tests pass with no database dependency
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligence-autonomy/07-02-SUMMARY.md`
</output>
