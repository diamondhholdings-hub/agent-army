---
phase: 07-intelligence-autonomy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/intelligence/__init__.py
  - src/app/intelligence/consolidation/__init__.py
  - src/app/intelligence/consolidation/schemas.py
  - src/app/intelligence/patterns/__init__.py
  - src/app/intelligence/patterns/schemas.py
  - src/app/intelligence/autonomy/__init__.py
  - src/app/intelligence/autonomy/schemas.py
  - src/app/intelligence/persona/__init__.py
  - src/app/intelligence/persona/schemas.py
  - src/app/intelligence/models.py
  - src/app/intelligence/repository.py
  - alembic/versions/add_intelligence_tables.py
  - tests/test_intelligence_models.py
autonomous: true

must_haves:
  truths:
    - "Intelligence module tables exist in tenant schema (agent_clones, insights, goals, autonomous_actions, alert_feedback)"
    - "Pydantic schemas define all Phase 7 data types with validation"
    - "IntelligenceRepository provides async CRUD for all 5 tables"
    - "Alembic migration creates tables successfully"
  artifacts:
    - path: "src/app/intelligence/models.py"
      provides: "SQLAlchemy models for agent_clones, insights, goals, autonomous_actions, alert_feedback"
      contains: "class AgentCloneModel"
    - path: "src/app/intelligence/repository.py"
      provides: "IntelligenceRepository with session_factory pattern"
      contains: "class IntelligenceRepository"
    - path: "src/app/intelligence/consolidation/schemas.py"
      provides: "UnifiedCustomerView, ChannelInteraction, SummarizedTimeline"
      contains: "class UnifiedCustomerView"
    - path: "src/app/intelligence/patterns/schemas.py"
      provides: "PatternMatch, Insight, Alert, AlertFeedback"
      contains: "class PatternMatch"
    - path: "src/app/intelligence/autonomy/schemas.py"
      provides: "AutonomyAction, GuardrailResult, ApprovalRequest, Goal, PerformanceMetrics"
      contains: "class GuardrailResult"
    - path: "src/app/intelligence/persona/schemas.py"
      provides: "PersonaConfig, CloneConfig, GeographicProfile, PersonaDimensions"
      contains: "class PersonaConfig"
  key_links:
    - from: "src/app/intelligence/repository.py"
      to: "src/app/intelligence/models.py"
      via: "SQLAlchemy model imports"
      pattern: "from src.app.intelligence.models import"
    - from: "src/app/intelligence/models.py"
      to: "src/app/core/database"
      via: "TenantBase inheritance"
      pattern: "class.*TenantBase"
---

<objective>
Create the data foundation for the entire Intelligence & Autonomy module -- Pydantic schemas for all 4 sub-systems, SQLAlchemy models for 5 new tables, the IntelligenceRepository, and the Alembic migration.

Purpose: Every sub-system in Phase 7 (consolidation, patterns, autonomy, persona) needs shared data types and persistence. Building the data layer first allows all subsequent plans to focus on business logic.

Output: Complete `src/app/intelligence/` package skeleton with schemas, models, repository, migration, and tests.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-intelligence-autonomy/07-CONTEXT.md
@.planning/phases/07-intelligence-autonomy/07-RESEARCH.md
@src/app/deals/models.py
@src/app/deals/repository.py
@src/app/intelligence/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pydantic schemas for all 4 sub-systems</name>
  <files>
    src/app/intelligence/__init__.py
    src/app/intelligence/consolidation/__init__.py
    src/app/intelligence/consolidation/schemas.py
    src/app/intelligence/patterns/__init__.py
    src/app/intelligence/patterns/schemas.py
    src/app/intelligence/autonomy/__init__.py
    src/app/intelligence/autonomy/schemas.py
    src/app/intelligence/persona/__init__.py
    src/app/intelligence/persona/schemas.py
  </files>
  <action>
    Create the `src/app/intelligence/` package with 4 sub-packages: consolidation, patterns, autonomy, persona. Each gets an `__init__.py` and `schemas.py`.

    **consolidation/schemas.py:**
    - `ChannelType(str, Enum)`: email, chat, meeting, crm
    - `ChannelInteraction(BaseModel)`: channel, timestamp, participants (list[str]), content_summary (str), signals (dict), source_id (str), account_id (str | None)
    - `ChannelSignal(BaseModel)`: signal_type (str), value (str), confidence (float 0-1), channel (ChannelType), timestamp (datetime), source_id (str)
    - `SummarizedTimeline(BaseModel)`: recent_interactions (list[ChannelInteraction]), medium_summaries (list with period + summary text), historical_summaries (list with period + summary text)
    - `UnifiedCustomerView(BaseModel)`: account_id (str), tenant_id (str), timeline (SummarizedTimeline), current_signals (dict[str, ChannelSignal]), stakeholder_map (list), action_history (list[ChannelInteraction]), last_updated (datetime)

    **patterns/schemas.py:**
    - `PatternType(str, Enum)`: buying_signal, risk_indicator, engagement_change, cross_account_pattern
    - `Severity(str, Enum)`: low, medium, high, critical
    - `PatternMatch(BaseModel)`: pattern_type (PatternType), confidence (float 0-1, Field ge/le), evidence (list[str] -- quotes from source data), severity (Severity), recommended_action (str), reasoning (str), account_id (str), detected_at (datetime)
    - `InsightStatus(str, Enum)`: pending, acted, dismissed
    - `Insight(BaseModel)`: id (str), tenant_id (str), account_id (str), pattern (PatternMatch), status (InsightStatus), created_at (datetime)
    - `Alert(BaseModel)`: insight_id (str), delivery_channel (str -- "sse" or "email"), delivered_at (datetime | None), priority (str)
    - `AlertFeedback(BaseModel)`: insight_id (str), feedback (str -- "useful" or "false_alarm"), comment (str | None), submitted_at (datetime)
    - `DailyDigest(BaseModel)`: tenant_id (str), clone_id (str | None), insights (list[Insight]), generated_at (datetime), period_start (datetime), period_end (datetime)

    **autonomy/schemas.py:**
    - `ActionCategory(str, Enum)`: autonomous, approval_required, hard_stop
    - `AutonomyAction(BaseModel)`: action_type (str), category (ActionCategory | None -- computed), target_account_id (str | None), target_contact_id (str | None), deal_stage (str | None), trigger_reason (str), proposed_content (str | None), clone_id (str | None)
    - `GuardrailResult(BaseModel)`: allowed (bool), reason (str), requires_human (bool), action (AutonomyAction)
    - `ApprovalStatus(str, Enum)`: pending, approved, rejected
    - `ApprovalRequest(BaseModel)`: id (str), action (AutonomyAction), guardrail_result (GuardrailResult), status (ApprovalStatus), requested_at (datetime), resolved_at (datetime | None), resolved_by (str | None)
    - `GoalType(str, Enum)`: revenue, pipeline, activity, quality
    - `GoalStatus(str, Enum)`: active, paused, completed, missed
    - `Goal(BaseModel)`: id (str), tenant_id (str), clone_id (str | None -- NULL = tenant-wide), goal_type (GoalType), target_value (float), current_value (float), period_start (datetime), period_end (datetime), status (GoalStatus)
    - `PerformanceMetrics(BaseModel)`: dollars_identified (float), dollars_in_pipeline (float), dollars_closed (float), deal_velocity_days (float | None), stage_conversion_rates (dict[str, float]), emails_sent (int), meetings_booked (int), responses_received (int), engagement_rate (float | None), qualification_completion_rate (float | None), escalation_rate (float | None), win_rate (float | None), avg_deal_size (float | None), sales_cycle_days (float | None)

    **persona/schemas.py:**
    - `PersonaDimensions(BaseModel)`: formality (float 0-1, default 0.5), aggressiveness (float 0-1, default 0.5), technical_depth (float 0-1, default 0.5), relationship_focus (float 0-1, default 0.5). All with Field(ge=0.0, le=1.0).
    - `PersonaConfig(BaseModel)`: clone_id (str), clone_name (str), owner_id (str -- sales rep who owns this clone), dimensions (PersonaDimensions), communication_examples (list[str], default_factory=list), geographic_region (str, default="americas"), custom_instructions (str, default=""), is_active (bool, default=True)
    - `CloneConfig(BaseModel)`: tenant_id (str), persona (PersonaConfig), shared_knowledge (bool, default=True -- shares product knowledge and methodologies), created_at (datetime), updated_at (datetime | None)
    - `GeographicProfile(BaseModel)`: region_code (str), communication_style (str), formality_default (float), relationship_approach (str), timezone_awareness (list[str]), cultural_notes (list[str])
    - `PersonaPreview(BaseModel)`: sample_email (str), sample_chat (str), persona_summary (str)

    All schemas use `from __future__ import annotations` and Pydantic v2 patterns.
  </action>
  <verify>
    Run `python -c "from src.app.intelligence.consolidation.schemas import UnifiedCustomerView; from src.app.intelligence.patterns.schemas import PatternMatch; from src.app.intelligence.autonomy.schemas import GuardrailResult; from src.app.intelligence.persona.schemas import PersonaConfig; print('All schemas import OK')"` from project root.
  </verify>
  <done>All 4 schema modules import without errors. UnifiedCustomerView, PatternMatch, GuardrailResult, PersonaConfig instantiable with valid data.</done>
</task>

<task type="auto">
  <name>Task 2: SQLAlchemy models, repository, migration, and tests</name>
  <files>
    src/app/intelligence/models.py
    src/app/intelligence/repository.py
    alembic/versions/add_intelligence_tables.py
    tests/test_intelligence_models.py
  </files>
  <action>
    **models.py:** Create 5 SQLAlchemy models following the Phase 5/6 pattern (TenantBase, JSON columns, UUID PKs, `schema="tenant"`):

    1. `AgentCloneModel`: id (UUID PK), tenant_id (UUID), clone_name (String 200), owner_id (String 100), persona_config (JSON), is_active (Boolean default True), performance_metrics (JSON default {}), created_at (DateTime server_default=func.now()), updated_at (DateTime onupdate=func.now()). UniqueConstraint on (tenant_id, clone_name).
    2. `InsightModel`: id (UUID PK), tenant_id (UUID), account_id (UUID), pattern_type (String 50), severity (String 20 default "medium"), confidence (Float), evidence (JSON default []), recommended_action (Text nullable), reasoning (Text nullable), status (String 20 default "pending"), feedback (String 20 nullable -- "useful"/"false_alarm"), created_at (DateTime server_default=func.now()).
    3. `GoalModel`: id (UUID PK), tenant_id (UUID), clone_id (UUID nullable -- NULL means tenant-wide), goal_type (String 50), target_value (Float), current_value (Float default 0.0), period_start (DateTime timezone=True), period_end (DateTime timezone=True), status (String 20 default "active"), created_at (DateTime server_default=func.now()).
    4. `AutonomousActionModel`: id (UUID PK), tenant_id (UUID), clone_id (UUID nullable), action_type (String 50), target_account_id (UUID nullable), target_contact_id (String 100 nullable), trigger_reason (Text), guardrail_result (String 20 -- "allowed"/"blocked"/"approval_required"), approval_status (String 20 nullable -- "pending"/"approved"/"rejected"), execution_result (JSON default {}), created_at (DateTime server_default=func.now()).
    5. `AlertFeedbackModel`: id (UUID PK), tenant_id (UUID), insight_id (UUID), feedback (String 20 -- "useful"/"false_alarm"), comment (Text nullable), created_at (DateTime server_default=func.now()).

    All use `from src.app.core.database import TenantBase` and `{"schema": "tenant"}` table args. Import patterns match `src/app/deals/models.py` exactly.

    **repository.py:** Create `IntelligenceRepository` with `session_factory` callable pattern (matching DealRepository):
    - `create_clone(tenant_id, clone_data) -> CloneConfig` -- insert AgentCloneModel
    - `get_clone(tenant_id, clone_id) -> CloneConfig | None`
    - `list_clones(tenant_id) -> list[CloneConfig]`
    - `update_clone(tenant_id, clone_id, updates) -> CloneConfig | None`
    - `deactivate_clone(tenant_id, clone_id) -> bool`
    - `create_insight(tenant_id, insight_data) -> Insight`
    - `list_insights(tenant_id, account_id=None, status=None, limit=50) -> list[Insight]`
    - `update_insight_status(tenant_id, insight_id, status, feedback=None) -> bool`
    - `create_goal(tenant_id, goal_data) -> Goal`
    - `list_goals(tenant_id, clone_id=None, status=None) -> list[Goal]`
    - `update_goal_progress(tenant_id, goal_id, current_value) -> bool`
    - `log_autonomous_action(tenant_id, action_data) -> str` -- returns action id
    - `list_autonomous_actions(tenant_id, clone_id=None, limit=50) -> list`
    - `submit_alert_feedback(tenant_id, insight_id, feedback, comment=None) -> str`
    - `get_feedback_stats(tenant_id) -> dict` -- returns useful/false_alarm counts

    Session handling: use `async with self._session_factory(tenant_id=tenant_id) as session:` pattern, `await session.commit()`, `await session.flush()` before reading auto-generated UUIDs.

    **migration:** Create Alembic migration following the Phase 5/6 pattern. Use `op.execute()` with raw SQL for tenant schema table creation (matching `add_deal_management_tables.py` and `add_meeting_tables.py` patterns). All tables in the `tenant` schema placeholder.

    **tests:** Create `tests/test_intelligence_models.py` with:
    - Test all 5 models can be instantiated with required fields
    - Test Pydantic schema round-trip: model_dump -> JSON -> model_validate for PersonaConfig, PatternMatch, Goal
    - Test repository methods with InMemoryIntelligenceRepository test double (matching InMemoryDealRepository pattern from Phase 5)
    - At least 15 test cases covering CRUD for clones, insights, goals, actions, and feedback
  </action>
  <verify>Run `python -m pytest tests/test_intelligence_models.py -v` -- all tests pass.</verify>
  <done>5 SQLAlchemy models created. IntelligenceRepository with 16 methods. Alembic migration file exists. All 15+ tests pass.</done>
</task>

</tasks>

<verification>
- `python -c "from src.app.intelligence.models import AgentCloneModel, InsightModel, GoalModel, AutonomousActionModel, AlertFeedbackModel"` succeeds
- `python -c "from src.app.intelligence.repository import IntelligenceRepository"` succeeds
- `python -m pytest tests/test_intelligence_models.py -v` -- all tests pass
- Migration file exists in `alembic/versions/`
</verification>

<success_criteria>
- All 4 schema sub-packages import cleanly
- 5 SQLAlchemy models with TenantBase and tenant schema
- IntelligenceRepository provides async CRUD for all tables
- Alembic migration creates all 5 tables
- 15+ tests pass covering models, schema round-trip, and repository CRUD
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligence-autonomy/07-01-SUMMARY.md`
</output>
