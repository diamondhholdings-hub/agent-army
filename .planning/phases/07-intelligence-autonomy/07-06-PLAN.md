---
phase: 07-intelligence-autonomy
plan: 06
type: execute
wave: 4
depends_on: ["07-01", "07-02", "07-03", "07-04", "07-05"]
files_modified:
  - src/app/api/v1/intelligence.py
  - src/app/api/v1/router.py
  - src/app/main.py
  - src/app/agents/sales/prompts.py
  - tests/test_intelligence_api.py
autonomous: true

must_haves:
  truths:
    - "Intelligence API endpoints are accessible and return correct responses"
    - "Phase 7 services initialize in main.py lifespan with failure-tolerant pattern"
    - "Persona prompt sections inject into SalesAgent system prompts"
    - "Intelligence scheduler tasks start as background asyncio loops"
    - "All existing tests continue to pass (no regressions)"
  artifacts:
    - path: "src/app/api/v1/intelligence.py"
      provides: "API endpoints for customer view, insights, goals, clones, approvals"
      exports: ["router"]
    - path: "src/app/main.py"
      provides: "Phase 7 service initialization in lifespan"
      contains: "phase7.intelligence_initialized"
    - path: "src/app/agents/sales/prompts.py"
      provides: "Clone persona and geographic prompt injection"
      contains: "build_clone_prompt_section\\|build_geographic_prompt_section"
  key_links:
    - from: "src/app/api/v1/intelligence.py"
      to: "src/app/intelligence/consolidation/customer_view.py"
      via: "CustomerViewService dependency injection"
      pattern: "customer_view_service"
    - from: "src/app/api/v1/intelligence.py"
      to: "src/app/intelligence/autonomy/engine.py"
      via: "AutonomyEngine dependency injection"
      pattern: "autonomy_engine"
    - from: "src/app/api/v1/router.py"
      to: "src/app/api/v1/intelligence.py"
      via: "router.include_router"
      pattern: "intelligence.router"
    - from: "src/app/main.py"
      to: "src/app/intelligence/"
      via: "Service initialization in lifespan"
      pattern: "Phase 7.*Intelligence"
---

<objective>
Wire everything together -- API endpoints for all intelligence features, main.py service initialization, prompt system integration for persona/geographic adaptation, and integration tests proving the full system works.

Purpose: This is the integration plan that makes Phase 7 accessible. Without wiring, the services exist but cannot be used. This plan connects the intelligence layer to the API, the agent prompt system, and the application lifecycle.

Output: API router with 15+ endpoints, main.py Phase 7 initialization block, prompt system integration, and integration tests.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-intelligence-autonomy/07-CONTEXT.md
@.planning/phases/07-intelligence-autonomy/07-RESEARCH.md
@.planning/phases/07-intelligence-autonomy/07-01-SUMMARY.md
@src/app/main.py
@src/app/api/v1/router.py
@src/app/api/v1/sales.py
@src/app/agents/sales/prompts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: API endpoints and router wiring</name>
  <files>
    src/app/api/v1/intelligence.py
    src/app/api/v1/router.py
  </files>
  <action>
    **intelligence.py:** Create API router with FastAPI endpoints following the existing sales.py / deals.py / meetings.py auth + tenant dependency pattern.

    Import `get_current_user` and `get_current_tenant` dependencies from existing auth module (matching sales.py pattern). Services are accessed from `request.app.state` with 503 fallback when not initialized (matching learning.py pattern).

    **Customer View endpoints:**
    - `GET /v1/intelligence/customer-view/{account_id}` -- Returns UnifiedCustomerView for an account. Requires tenant auth. Calls customer_view_service.get_unified_view(). Returns 503 if service not initialized.
    - `GET /v1/intelligence/customer-view/{account_id}/recent` -- Returns recent activity (last 7 days). Query param `days: int = 7`.

    **Insights endpoints:**
    - `GET /v1/intelligence/insights` -- List insights for tenant. Query params: account_id (optional), status (optional: pending/acted/dismissed), limit (default 50). Returns list of Insight schemas.
    - `POST /v1/intelligence/insights/{insight_id}/feedback` -- Submit feedback on an insight. Body: `{"feedback": "useful"|"false_alarm", "comment": "..."}`. Calls insight_generator.process_feedback().
    - `GET /v1/intelligence/insights/digest` -- Get daily digest. Query param: clone_id (optional).
    - `GET /v1/intelligence/insights/feedback-stats` -- Get feedback statistics for threshold tuning.

    **Goals endpoints:**
    - `POST /v1/intelligence/goals` -- Create a new goal. Body: GoalCreate schema (goal_type, target_value, period_start, period_end, clone_id optional).
    - `GET /v1/intelligence/goals` -- List goals. Query params: clone_id (optional), status (optional).
    - `GET /v1/intelligence/goals/{goal_id}/status` -- Get goal status with progress percentage and on-track indicator.
    - `GET /v1/intelligence/metrics` -- Get current performance metrics. Query param: clone_id (optional).

    **Clone/Persona endpoints:**
    - `POST /v1/intelligence/clones` -- Create a new agent clone. Body: PersonaConfig (clone_name, owner_id, dimensions, region, etc.).
    - `GET /v1/intelligence/clones` -- List all clones for tenant.
    - `GET /v1/intelligence/clones/{clone_id}` -- Get clone details.
    - `PUT /v1/intelligence/clones/{clone_id}` -- Update clone persona config.
    - `DELETE /v1/intelligence/clones/{clone_id}` -- Deactivate clone (soft delete).
    - `POST /v1/intelligence/clones/preview` -- Generate persona preview from PersonaConfig. Returns PersonaPreview (sample email, sample chat, persona summary).
    - `GET /v1/intelligence/persona/dimensions` -- Get dimension options for guided builder UI.

    **Autonomy endpoints:**
    - `GET /v1/intelligence/autonomy/pending` -- List pending approval requests.
    - `POST /v1/intelligence/autonomy/{action_id}/approve` -- Approve a pending action. Body: `{"approved": true|false, "resolved_by": "user_id"}`.
    - `POST /v1/intelligence/autonomy/scan/{account_id}` -- Trigger pattern scan for an account (on-demand, not just scheduled).

    All endpoints:
    - Use `request: Request` parameter to access `request.app.state`
    - Helper function `_get_intelligence_service(request, service_name)` returns service or raises HTTPException(503)
    - Return Pydantic schemas directly (FastAPI auto-serialization)
    - Tenant-scoped via `get_current_tenant` dependency

    **router.py:** Add `from src.app.api.v1 import intelligence` to imports and `router.include_router(intelligence.router)` to the router file.
  </action>
  <verify>Run `python -c "from src.app.api.v1.intelligence import router; print(f'{len(router.routes)} routes defined')"` -- should show 18+ routes.</verify>
  <done>Intelligence API router with 18+ endpoints registered in v1 router.</done>
</task>

<task type="auto">
  <name>Task 2: main.py wiring, prompt integration, and integration tests</name>
  <files>
    src/app/main.py
    src/app/agents/sales/prompts.py
    tests/test_intelligence_api.py
  </files>
  <action>
    **main.py:** Add Phase 7 initialization block in the lifespan function, AFTER Phase 6 block and BEFORE the `yield` statement. Follow the existing per-module try/except pattern exactly.

    ```python
    # ── Phase 7: Intelligence & Autonomy ──────────────────────────────
    try:
        from src.app.intelligence.repository import IntelligenceRepository
        from src.app.intelligence.consolidation.entity_linker import EntityLinker
        from src.app.intelligence.consolidation.summarizer import ContextSummarizer
        from src.app.intelligence.consolidation.customer_view import CustomerViewService
        from src.app.intelligence.patterns.engine import create_default_engine
        from src.app.intelligence.patterns.insights import InsightGenerator
        from src.app.intelligence.autonomy.guardrails import GuardrailChecker
        from src.app.intelligence.autonomy.goals import GoalTracker
        from src.app.intelligence.autonomy.engine import AutonomyEngine
        from src.app.intelligence.autonomy.scheduler import (
            setup_intelligence_scheduler,
            start_intelligence_scheduler_background,
        )
        from src.app.intelligence.persona.geographic import GeographicAdapter
        from src.app.intelligence.persona.cloning import AgentCloneManager
        from src.app.intelligence.persona.persona_builder import PersonaBuilder
        from src.app.core.database import get_tenant_session as _get_intel_session

        intel_repo = IntelligenceRepository(session_factory=_get_intel_session)
        app.state.intelligence_repository = intel_repo

        # Consolidation
        entity_linker = EntityLinker()
        summarizer = ContextSummarizer(llm_service=llm_service)
        customer_view_service = CustomerViewService(
            conversation_store=getattr(app.state, "conversation_store", None),
            state_repository=getattr(app.state, "sales_agent", None) and getattr(app.state.sales_agent, "_state_repository", None),
            deal_repository=getattr(app.state, "deal_repository", None),
            meeting_repository=getattr(app.state, "meeting_repository", None),
            summarizer=summarizer,
            entity_linker=entity_linker,
        )
        app.state.customer_view_service = customer_view_service

        # Patterns
        pattern_engine = create_default_engine(llm_service=llm_service)
        insight_generator = InsightGenerator(
            repository=intel_repo,
            event_bus=getattr(app.state, "event_bus", None),
        )
        app.state.pattern_engine = pattern_engine
        app.state.insight_generator = insight_generator

        # Autonomy
        guardrail_checker = GuardrailChecker()
        goal_tracker = GoalTracker(repository=intel_repo)
        autonomy_engine = AutonomyEngine(
            guardrail_checker=guardrail_checker,
            goal_tracker=goal_tracker,
            pattern_engine=pattern_engine,
            repository=intel_repo,
            llm_service=llm_service,
        )
        app.state.autonomy_engine = autonomy_engine
        app.state.goal_tracker = goal_tracker
        app.state.guardrail_checker = guardrail_checker

        # Persona & Cloning
        geographic_adapter = GeographicAdapter()
        clone_manager = AgentCloneManager(repository=intel_repo, llm_service=llm_service)
        persona_builder = PersonaBuilder(llm_service=llm_service, geographic_adapter=geographic_adapter)
        app.state.geographic_adapter = geographic_adapter
        app.state.clone_manager = clone_manager
        app.state.persona_builder = persona_builder

        # Intelligence scheduler (background tasks)
        intel_tasks = await setup_intelligence_scheduler(
            pattern_engine=pattern_engine,
            autonomy_engine=autonomy_engine,
            goal_tracker=goal_tracker,
            insight_generator=insight_generator,
            customer_view_service=customer_view_service,
        )
        await start_intelligence_scheduler_background(intel_tasks, app.state)

        log.info("phase7.intelligence_initialized")
    except Exception as exc:
        log.warning("phase7.intelligence_init_failed", error=str(exc))
        # Set all to None for graceful 503 responses
        app.state.intelligence_repository = None
        app.state.customer_view_service = None
        app.state.pattern_engine = None
        app.state.insight_generator = None
        app.state.autonomy_engine = None
        app.state.goal_tracker = None
        app.state.guardrail_checker = None
        app.state.geographic_adapter = None
        app.state.clone_manager = None
        app.state.persona_builder = None
    ```

    Also add shutdown cleanup for intelligence scheduler tasks in the shutdown section (after the existing Phase 4.1 scheduler cleanup):
    ```python
    intel_scheduler_refs = getattr(app.state, "intelligence_scheduler_tasks", None)
    if intel_scheduler_refs:
        for task_ref in intel_scheduler_refs:
            task_ref.cancel()
    ```

    **prompts.py:** Add two integration points to the existing prompt system:

    1. Add a new function `build_persona_prompt_section(clone_config=None, geographic_adapter=None, region=None) -> str` that:
       - If clone_config is provided, imports AgentCloneManager and calls build_clone_prompt_section(clone_config.persona)
       - If geographic_adapter and region are provided, calls geographic_adapter.build_geographic_prompt_section(region)
       - Returns combined prompt section (or empty string if neither provided)

    2. Modify `build_system_prompt()` to accept optional `persona_section: str = ""` parameter. If non-empty, append it AFTER the methodology sections but BEFORE the closing instructions. This ensures methodology (BANT, MEDDIC, QBS, Voss) prompts are NOT overridable by persona (per CONTEXT.md and RESEARCH.md Pitfall 5).

    Do NOT change the function signature in a breaking way -- persona_section defaults to empty string so all existing callers are unaffected.

    **tests/test_intelligence_api.py:** Integration tests:

    1. API endpoint tests (10+) using FastAPI TestClient:
       - `test_get_customer_view_503_when_not_initialized` -- returns 503 if service is None
       - `test_list_insights_empty` -- returns empty list
       - `test_create_goal` -- POST creates goal, returns 201
       - `test_list_goals` -- GET returns goals list
       - `test_create_clone` -- POST creates clone, returns 201
       - `test_list_clones` -- GET returns clones list
       - `test_deactivate_clone` -- DELETE returns 200
       - `test_persona_preview` -- POST returns preview with sample_email and sample_chat
       - `test_dimension_options` -- GET returns 4 dimensions
       - `test_pending_approvals_empty` -- returns empty list
       - `test_submit_feedback` -- POST feedback returns 200

    2. Integration wiring tests (5+):
       - `test_intelligence_router_registered` -- intelligence routes in v1 router
       - `test_build_persona_prompt_section_with_clone` -- persona section generated
       - `test_build_system_prompt_with_persona` -- persona section appended after methodology
       - `test_build_system_prompt_without_persona` -- backward compatible (empty string)
       - `test_methodology_not_overridden` -- BANT/MEDDIC/QBS sections present even with persona

    Use in-memory test doubles for services. Set app.state attributes manually in test fixtures. No actual database required.
  </action>
  <verify>
    Run `python -m pytest tests/test_intelligence_api.py -v` -- all tests pass.
    Run `python -m pytest tests/ -v --timeout=120` -- full test suite passes (no regressions).
  </verify>
  <done>18+ API endpoints accessible. Phase 7 initializes in main.py. Persona prompts inject without overriding methodology. Intelligence scheduler starts in background. Full test suite passes.</done>
</task>

</tasks>

<verification>
- `python -m pytest tests/test_intelligence_api.py -v` -- all intelligence tests pass
- `python -m pytest tests/ -v --timeout=120` -- full test suite passes (no regressions from existing 893+ tests)
- `python -c "from src.app.api.v1.intelligence import router"` -- router imports
- Intelligence endpoints return 503 gracefully when services not initialized
- Persona prompt section does NOT override BANT/MEDDIC/QBS methodology sections
</verification>

<success_criteria>
- 18+ API endpoints accessible at /v1/intelligence/*
- Phase 7 services initialize in main.py with per-module try/except resilience
- Persona/geographic prompt sections inject into system prompts without breaking methodology
- Intelligence scheduler starts 5 background tasks
- Scheduler tasks clean up on shutdown
- All existing 893+ tests continue to pass (zero regressions)
- 15+ new integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligence-autonomy/07-06-SUMMARY.md`
</output>
