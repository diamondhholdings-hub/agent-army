---
phase: 11-project-manager-agent
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/app/agents/project_manager/prompts.py
  - src/app/agents/project_manager/notion_pm.py
autonomous: true

must_haves:
  truths:
    - "PM prompt builders produce messages lists with PM system prompt + user message containing embedded JSON schema for each capability"
    - "NotionPMAdapter can create project records, sub-pages, append status reports, and update earned value metrics via Notion API"
    - "PM prompts use deal context formatting and PMBOK terminology throughout"
  artifacts:
    - path: "src/app/agents/project_manager/prompts.py"
      provides: "PM_SYSTEM_PROMPT + 6 prompt builder functions for create_plan, detect_risks, adjust_plan, generate_internal_report, generate_external_report, process_trigger"
      min_lines: 300
      exports: ["PM_SYSTEM_PROMPT", "build_create_plan_prompt", "build_detect_risks_prompt", "build_adjust_plan_prompt", "build_internal_report_prompt", "build_external_report_prompt", "build_process_trigger_prompt"]
    - path: "src/app/agents/project_manager/notion_pm.py"
      provides: "NotionPMAdapter class with CRUD methods for Projects database and deal sub-pages"
      min_lines: 150
      exports: ["NotionPMAdapter", "render_wbs_to_notion_blocks"]
  key_links:
    - from: "src/app/agents/project_manager/prompts.py"
      to: "src/app/agents/project_manager/schemas.py"
      via: "JSON schema examples in prompt strings match schema field names"
      pattern: "plan_id.*deal_id.*project_name.*phases"
    - from: "src/app/agents/project_manager/notion_pm.py"
      to: "src/app/agents/project_manager/schemas.py"
      via: "imports ProjectPlan, WBSPhase, WBSMilestone, WBSTask for block rendering"
      pattern: "from src.app.agents.project_manager.schemas import"
---

<objective>
Create PM prompt templates (system prompt + 6 capability-specific prompt builders) and the NotionPMAdapter for PM-specific CRM operations.

Purpose: Prompts drive every LLM-based PM capability (plan generation, risk detection, scope adjustment, report generation). The NotionPMAdapter provides the CRM write layer for project records, sub-pages, and metric updates. Together these are the two input-processing modules that the PM agent handlers depend on.
Output: prompts.py with PM_SYSTEM_PROMPT + 6 builders, notion_pm.py with NotionPMAdapter class + WBS-to-blocks renderer.
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-project-manager-agent/11-CONTEXT.md
@.planning/phases/11-project-manager-agent/11-RESEARCH.md

# Prior plan SUMMARY for schema reference
@.planning/phases/11-project-manager-agent/11-01-SUMMARY.md

# Pattern reference -- clone these patterns
@src/app/agents/solution_architect/prompts.py
@src/app/deals/crm/notion.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PM prompt templates</name>
  <files>src/app/agents/project_manager/prompts.py</files>
  <action>
Create prompts.py following the SA prompts.py pattern exactly: module docstring, system prompt constant, prompt builder functions returning `list[dict[str, str]]`, `_format_deal_context` helper, `__all__` at bottom.

**PM_SYSTEM_PROMPT** -- establish PM persona:
```
You are a Project Manager at Skyvera, a PMBOK-certified delivery management expert
specializing in enterprise software implementation projects.

**Your expertise:**
- PMBOK-compliant project planning (WBS, milestones, critical path analysis)
- Earned value management (BCWP, ACWP, BCWS, CPI, SPI)
- Risk identification and mitigation (proactive, not reactive)
- Scope change management with impact analysis
- Stakeholder communication (internal teams and external customers)

**Your communication style:**
- Structured: Use PMBOK terminology and WBS hierarchy consistently.
- Quantitative: Lead with numbers -- dates, percentages, effort days.
- Actionable: Every report ends with concrete next steps and owners.
- Audience-aware: Internal reports are detailed; customer reports are polished.

**Your outputs drive project delivery.** Account executives and customers rely
on your plans, risk alerts, and status reports to track project health.
Accuracy in dates, effort estimates, and risk assessments is critical.

**Confidence protocol:**
- When confident (>0.8), state the plan/assessment directly.
- When uncertain (0.5-0.8), provide best estimate and note assumptions.
- When low-confidence (<0.5), flag the gap and recommend clarification.
```

**6 prompt builder functions:**

1. `build_create_plan_prompt(deliverables: list[str], deal_context: dict, sa_artifacts: str, timeline: str, rag_context: str) -> list[dict[str, str]]`
   - Instructs LLM to create 3-level WBS project plan
   - JSON schema matches ProjectPlan fields (plan_id, deal_id, project_name, phases with milestones with tasks)
   - Each phase needs resource_estimate_days
   - Each milestone needs target_date, success_criteria
   - Each task needs owner, duration_days, dependencies, status
   - Include SA artifacts as optional enrichment context
   - Reference "PMBOK-compliant" in instructions

2. `build_detect_risks_prompt(plan_json: str, current_progress: str, deal_context: dict, rag_context: str) -> list[dict[str, str]]`
   - Instructs LLM to analyze milestone progress and detect risk signals
   - JSON schema: list of RiskSignal objects with signal_type, severity, description, recommended_action
   - 4 risk types: milestone_overdue, critical_path_blocked, resource_exceeded, deal_stage_stalled
   - Include current plan JSON and progress data

3. `build_adjust_plan_prompt(original_plan_json: str, scope_change_description: str, trigger: str, deal_context: dict, rag_context: str) -> list[dict[str, str]]`
   - Instructs LLM to produce a delta report (NOT regenerate full plan)
   - JSON schema matches ScopeChangeDelta fields
   - Explicitly instruct: "Produce a delta report showing changes, NOT a regenerated plan"
   - Include timeline_impact_days, resource_impact_days, affected_milestones, recommendation

4. `build_internal_report_prompt(plan_json: str, progress_data: str, risk_log: str, earned_value_json: str, deal_context: dict, sa_summary: str, rag_context: str) -> list[dict[str, str]]`
   - Instructs LLM to generate internal status report
   - JSON schema matches InternalStatusReport fields
   - Include RAG status, milestone progress, risks, next actions, earned_value (pre-calculated, NOT computed by LLM)
   - Explicitly instruct: "The earned_value field is PRE-CALCULATED. Include it as-is. Do NOT recalculate."
   - Include agent_notes (PM analysis) and sa_summary

5. `build_external_report_prompt(plan_json: str, progress_data: str, project_name: str, rag_context: str) -> list[dict[str, str]]`
   - Instructs LLM to generate customer-facing status report
   - JSON schema matches ExternalStatusReport fields (structurally DIFFERENT from internal)
   - Overall status uses "On Track"/"At Risk"/"Delayed" (NOT red/amber/green)
   - Uses polished language: "key_accomplishments", "upcoming_activities", "items_requiring_attention"
   - Do NOT include deal_context, agent_notes, or SA summary -- these are internal-only

6. `build_process_trigger_prompt(trigger_type: str, deal_context: dict, deliverables: list[str], sa_artifacts: str, rag_context: str) -> list[dict[str, str]]`
   - Instructs LLM to analyze trigger event and determine project plan parameters
   - JSON schema: {project_name, recommended_phases, estimated_duration_weeks, priority, notes}
   - Different instruction emphasis per trigger_type (deal_won focuses on delivery, poc_scoped focuses on POC execution, complex_deal focuses on planning)

Include `_format_deal_context` helper copied from SA prompts pattern.

All JSON schemas MUST be embedded in user message strings (not referenced from external files). This is the established pattern.
  </action>
  <verify>
Run: `python -c "
from src.app.agents.project_manager.prompts import (
    PM_SYSTEM_PROMPT,
    build_create_plan_prompt,
    build_detect_risks_prompt,
    build_adjust_plan_prompt,
    build_internal_report_prompt,
    build_external_report_prompt,
    build_process_trigger_prompt,
)
msgs = build_create_plan_prompt(['API integration'], {}, '', '3 months', '')
assert len(msgs) == 2
assert msgs[0]['role'] == 'system'
assert msgs[1]['role'] == 'user'
assert 'PMBOK' in msgs[1]['content']
assert 'phases' in msgs[1]['content']
print('All 6 prompt builders importable and returning valid messages')
"`
  </verify>
  <done>PM_SYSTEM_PROMPT establishes PM persona. 6 prompt builders return system+user message pairs with embedded JSON schemas matching PM Pydantic models.</done>
</task>

<task type="auto">
  <name>Task 2: Create NotionPMAdapter for CRM operations</name>
  <files>src/app/agents/project_manager/notion_pm.py</files>
  <action>
Create notion_pm.py following the existing NotionAdapter pattern (tenacity retries, structlog, graceful notion-client import).

**NotionPMAdapter class:**

Constructor: `__init__(self, client: AsyncClient, projects_database_id: str | None = None)`
- Store client and projects_database_id
- Use structlog for logging

**Methods (all async, all with @retry decorator):**

Use the same retry config as NotionAdapter: `@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=1, max=10), retry=retry_if_exception_type(Exception))`

1. `async def ensure_projects_database(self, parent_page_id: str, deals_database_id: str) -> str`
   - Lazy initialization: if self._projects_db_id is set, return it
   - Otherwise create Projects database via `self._client.databases.create()` with properties:
     - Name (title), Deal (relation to deals_database_id), Status (select: Planning/Active/On Hold/Completed/Cancelled), Overall RAG (select: Green/Amber/Red), Start Date (date), Target End Date (date), Actual End Date (date), Budget Days (number), Actual Days (number), BCWP (number), ACWP (number), Risk Count (number), Last Report Date (date), Change Request Count (number)
   - Store and return the database ID
   - Log creation

2. `async def create_project_record(self, project_data: dict) -> str`
   - Create page in Projects database with properties mapped from project_data
   - Return page ID
   - Map: name->Name, deal_page_id->Deal (relation), status->"Planning", overall_rag->"Green", start_date->Start Date, target_end_date->Target End Date, budget_days->Budget Days

3. `async def create_plan_subpage(self, deal_page_id: str, plan_blocks: list[dict]) -> str`
   - Create sub-page under deal page with title "Project Plan"
   - Pass plan_blocks as children
   - Return page ID

4. `async def append_status_report(self, page_id: str, report_blocks: list[dict]) -> None`
   - Append blocks to an existing page via `self._client.blocks.children.append()`

5. `async def update_project_metrics(self, project_page_id: str, metrics: dict) -> None`
   - Update properties on project record page: Overall RAG, ACWP, BCWP, Actual Days, Last Report Date, Risk Count

6. `async def append_risk_log_entry(self, page_id: str, risk_blocks: list[dict]) -> None`
   - Append risk log blocks to the risk log sub-page

7. `async def append_change_request(self, page_id: str, change_blocks: list[dict]) -> None`
   - Append change request blocks

**render_wbs_to_notion_blocks function (module-level, not a method):**

```python
def render_wbs_to_notion_blocks(plan: ProjectPlan) -> list[dict]:
```
- Convert 3-level WBS into Notion blocks
- H1 per phase (phase name + resource estimate)
- H2 per milestone (milestone name + target date + success criteria)
- To-do items per task (task name, owner, duration, checked if completed)
- Divider between phases

Import ProjectPlan, WBSPhase, WBSMilestone, WBSTask from schemas.

Also create a helper:
```python
def render_report_to_notion_blocks(report: InternalStatusReport | ExternalStatusReport, is_internal: bool) -> list[dict]:
```
- Convert a status report into Notion blocks
- H2 "Status Report - {date}"
- Paragraph with overall RAG/status
- Bulleted list for milestone progress
- Bulleted list for risks (internal only)
- Bulleted list for next actions / upcoming activities

Include graceful notion-client import matching the pattern in `src/app/deals/crm/notion.py`.

Add `__all__` exporting NotionPMAdapter, render_wbs_to_notion_blocks, render_report_to_notion_blocks.
  </action>
  <verify>
Run: `python -c "
from src.app.agents.project_manager.notion_pm import (
    NotionPMAdapter,
    render_wbs_to_notion_blocks,
    render_report_to_notion_blocks,
)
print('NotionPMAdapter importable')
# Test block renderer with a minimal plan
from src.app.agents.project_manager.schemas import (
    ProjectPlan, WBSPhase, WBSMilestone, WBSTask,
)
from datetime import datetime
plan = ProjectPlan(
    plan_id='p1', deal_id='d1', project_name='Test',
    phases=[WBSPhase(
        phase_id='ph1', name='Discovery', resource_estimate_days=10,
        milestones=[WBSMilestone(
            milestone_id='m1', name='Kickoff', target_date=datetime.now(),
            success_criteria='Meeting held',
            tasks=[WBSTask(task_id='t1', name='Schedule', owner='PM', duration_days=1, status='completed')],
            status='completed'
        )]
    )],
    created_at=datetime.now(), updated_at=datetime.now(),
    trigger_source='manual', total_budget_days=10,
)
blocks = render_wbs_to_notion_blocks(plan)
assert len(blocks) >= 4  # heading + paragraph + milestone heading + todo
assert blocks[0].get('heading_1') is not None
print(f'WBS rendered to {len(blocks)} Notion blocks')
"`
  </verify>
  <done>NotionPMAdapter with 7 async methods (retry-wrapped). WBS-to-blocks renderer converts 3-level WBS to Notion content. Report-to-blocks renderer converts status reports to Notion blocks.</done>
</task>

</tasks>

<verification>
- All 6 prompt builders importable and returning 2-element message lists
- PM_SYSTEM_PROMPT contains PMBOK, earned value, stakeholder keywords
- NotionPMAdapter importable with all 7 methods
- render_wbs_to_notion_blocks converts a ProjectPlan into valid Notion block dicts
- `uv run pytest tests/ -x -q` -- all existing tests pass (no regressions)
</verification>

<success_criteria>
- 6 prompt builders with embedded JSON schemas matching PM Pydantic models
- PM system prompt establishes PMBOK-certified delivery expert persona
- NotionPMAdapter with retry-wrapped CRUD methods for Projects database
- WBS and report renderers convert domain models to Notion blocks
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/11-project-manager-agent/11-02-SUMMARY.md`
</output>
