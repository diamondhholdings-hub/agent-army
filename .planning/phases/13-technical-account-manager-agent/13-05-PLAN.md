---
phase: 13-technical-account-manager-agent
plan: 05
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - src/app/agents/sales/agent.py
  - tests/test_tam_handoff.py
autonomous: true

must_haves:
  truths:
    - "Sales Agent dispatches to TAM on keyword triggers or deal stage threshold"
    - "Sales Agent dispatch uses lazy import pattern to avoid circular deps"
    - "Round-trip handoff test proves Sales->TAM dispatch works"
    - "TAM trigger heuristic requires 2+ keyword matches (same threshold as other triggers)"
    - "Sales Agent can dispatch health check requests to TAM via event bus"
  artifacts:
    - path: "src/app/agents/sales/agent.py"
      provides: "dispatch_tam_health_check handler + _is_tam_trigger heuristic"
      contains: "dispatch_tam_health_check"
    - path: "tests/test_tam_handoff.py"
      provides: "Round-trip integration tests for Sales->TAM handoff"
      min_lines: 100
  key_links:
    - from: "src/app/agents/sales/agent.py"
      to: "src/app/agents/technical_account_manager/schemas.py"
      via: "lazy import TAMHandoffRequest inside dispatch function body"
      pattern: "from src.app.agents.technical_account_manager.schemas import"
    - from: "tests/test_tam_handoff.py"
      to: "src/app/agents/technical_account_manager"
      via: "imports TAMAgent + schemas for round-trip test"
      pattern: "from src.app.agents.technical_account_manager"
---

<objective>
Add TAM dispatch handler to the Sales Agent, with round-trip integration tests proving cross-agent handoff works.

Purpose: Completes the TAM agent's integration into the multi-agent system. Sales Agent can trigger health checks, escalation outreach, and other TAM tasks from conversations.
Output: Updated sales/agent.py (dispatch_tam_health_check + trigger heuristic), test_tam_handoff.py
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-technical-account-manager-agent/13-CONTEXT.md
@.planning/phases/13-technical-account-manager-agent/13-RESEARCH.md

# Pattern references -- dispatch patterns to clone
@src/app/agents/sales/agent.py

# Handoff test patterns
@tests/test_ba_handoff.py
@tests/test_business_analyst.py

# Dependencies
@src/app/agents/technical_account_manager/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TAM dispatch to Sales Agent</name>
  <files>src/app/agents/sales/agent.py</files>
  <action>
**Sales Agent (src/app/agents/sales/agent.py):**

1. Add `"dispatch_tam_health_check": self._handle_dispatch_tam_health_check` to the handlers dict in the execute() router.

2. Add the trigger heuristic as a static method:
```python
@staticmethod
def _is_tam_trigger(text: str, deal_stage: str) -> bool:
    """Detect if message should trigger TAM health check or account review.

    Triggers on:
    1. Keyword signals in message text (2+ matches required to reduce false positives)
    2. Deal in post-sale or account management stages

    Returns True if either condition met.
    """
    TAM_KEYWORDS = [
        "health check", "account health", "technical issues",
        "integration problem", "api error", "downtime", "outage",
        "escalation", "at risk", "ticket", "support issue",
        "technical review", "health report", "customer success",
        "release notes", "roadmap preview", "check-in",
    ]
    keyword_matches = sum(1 for kw in TAM_KEYWORDS if kw in text.lower())
    keyword_trigger = keyword_matches >= 2

    stage_normalized = deal_stage.lower().replace(" ", "_")
    stage_trigger = stage_normalized in (
        "closed_won", "onboarding", "active_customer",
        "renewal", "account_management",
    )

    return keyword_trigger or stage_trigger
```

3. Add a module-level constant for TAM request type mapping:
```python
# Explicit mapping from TAM request types to TAM agent task_type keys.
TAM_REQUEST_TO_TASK_TYPE = {
    "health_scan": "health_scan",
    "escalation_outreach": "escalation_outreach",
    "release_notes": "release_notes",
    "roadmap_preview": "roadmap_preview",
    "health_checkin": "health_checkin",
    "customer_success_review": "customer_success_review",
}
```

4. Add the dispatch handler:
```python
async def _handle_dispatch_tam_health_check(
    self, task: dict[str, Any], context: dict[str, Any]
) -> dict[str, Any]:
    """Dispatch health check or communication request to the TAM agent.

    Uses lazy import to avoid circular dependency.

    Args:
        task: Must include 'account_id'. Optional: 'request_type'
              (health_scan|escalation_outreach|release_notes|roadmap_preview|
              health_checkin|customer_success_review). Defaults to health_scan.
        context: Execution context with tenant_id.

    Returns:
        Dict with status, handoff_task, payload, and target_agent_id.
    """
    account_id = task.get("account_id", "")
    if not account_id:
        return {
            "status": "failed",
            "error": "account_id is required for TAM dispatch",
        }

    # Lazy import to avoid circular dependency
    from src.app.agents.technical_account_manager.schemas import TAMHandoffRequest

    request_type = task.get("request_type", "health_scan")

    request = TAMHandoffRequest(
        account_id=account_id,
        tenant_id=context.get("tenant_id", ""),
        deal_id=task.get("deal_id"),
        request_type=request_type,
    )

    # Use explicit dict mapping
    task_type = TAM_REQUEST_TO_TASK_TYPE.get(request_type, "health_scan")

    handoff_task = {
        "type": task_type,
        "account_id": account_id,
        "deal_id": task.get("deal_id", ""),
        "release_info": task.get("release_info", {}),
        "metadata": task.get("metadata", {}),
    }

    logger.info(
        "tam_health_check_dispatched",
        account_id=account_id,
        request_type=request_type,
        task_type=task_type,
        tenant_id=context.get("tenant_id", ""),
    )

    return {
        "status": "dispatched",
        "handoff_task": handoff_task,
        "payload": request.model_dump_json(),
        "target_agent_id": "technical_account_manager",
    }
```

Place `TAM_REQUEST_TO_TASK_TYPE` as a module-level constant near the existing `SCOPE_TO_TASK_TYPE` (from Phase 12).

5. Update the module docstring to mention dispatch_tam_health_check alongside dispatch_technical_question, dispatch_project_trigger, and dispatch_requirements_analysis.

CRITICAL: The dispatch handler MUST use lazy import (`from src.app.agents.technical_account_manager.schemas import TAMHandoffRequest` INSIDE the function body, NOT at module top level). This prevents circular imports.
  </action>
  <verify>
Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -c "
from src.app.agents.sales.agent import SalesAgent
assert hasattr(SalesAgent, '_handle_dispatch_tam_health_check'), 'Sales Agent missing TAM dispatch handler'
assert hasattr(SalesAgent, '_is_tam_trigger'), 'Sales Agent missing TAM trigger heuristic'
print('Sales Agent TAM dispatch OK')
"` -- must succeed.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -c "
# Verify lazy import works (no circular import)
from src.app.agents.sales.agent import SalesAgent
from src.app.agents.technical_account_manager.schemas import TAMHandoffRequest
print('No circular imports')
"` -- must succeed.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && grep -n 'TAM_REQUEST_TO_TASK_TYPE' src/app/agents/sales/agent.py` -- must find the explicit mapping dict.
  </verify>
  <done>
Sales Agent has dispatch_tam_health_check with keyword/stage trigger heuristic and explicit TAM_REQUEST_TO_TASK_TYPE dict mapping. Uses lazy import pattern. All request types map to correct TAM task router keys.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create round-trip handoff integration tests</name>
  <files>tests/test_tam_handoff.py</files>
  <action>
Create `tests/test_tam_handoff.py` following the patterns in test_ba_handoff.py.

**Tests (minimum 10):**

1. `test_sales_agent_tam_trigger_keyword_detection` -- Test _is_tam_trigger with various texts:
   - "We have a health check issue and technical issues with integration" -> True (2+ keyword matches)
   - "Hello, nice weather" -> False (0 matches)
   - "We have a health check" -> False (only 1 match, need 2+)

2. `test_sales_agent_tam_trigger_stage_detection` -- Test _is_tam_trigger with stage triggers:
   - deal_stage="closed_won" -> True
   - deal_stage="Active Customer" -> True (case insensitive, space normalized)
   - deal_stage="prospecting" -> False

3. `test_sales_agent_dispatch_tam_health_check` -- Create SalesAgent with mock LLM, call execute with type="dispatch_tam_health_check", account_id="acc-1". Assert result has status="dispatched", target_agent_id="technical_account_manager", handoff_task with type="health_scan".

4. `test_sales_agent_dispatch_tam_missing_account_id` -- Call dispatch without account_id. Assert status="failed".

5. `test_sales_agent_tam_request_type_mapping` -- Verify all 6 request types map correctly:
   - "health_scan" -> handoff_task["type"] == "health_scan"
   - "escalation_outreach" -> handoff_task["type"] == "escalation_outreach"
   - "release_notes" -> handoff_task["type"] == "release_notes"
   - "roadmap_preview" -> handoff_task["type"] == "roadmap_preview"
   - "health_checkin" -> handoff_task["type"] == "health_checkin"
   - "customer_success_review" -> handoff_task["type"] == "customer_success_review"

6. `test_sales_agent_tam_default_request_type` -- Call dispatch without specifying request_type. Assert handoff_task["type"] == "health_scan" (default).

7. `test_sales_to_tam_round_trip_health_scan` -- Full round-trip:
   a. Create Sales Agent (mock LLM) and TAM Agent (mock LLM, real HealthScorer, mock ticket_client returning 2 P1 tickets)
   b. Sales Agent dispatches tam_health_check
   c. Use dispatch result's handoff_task to call TAM Agent's execute()
   d. Assert TAM Agent returns health score in result

8. `test_sales_to_tam_round_trip_escalation_outreach` -- Full round-trip:
   a. Create Sales Agent and TAM Agent (mock LLM returning escalation JSON, mock gmail returning draft_id)
   b. Sales Agent dispatches with request_type="escalation_outreach"
   c. TAM Agent generates outreach
   d. Assert create_draft was called (not send_email for the outreach communication)

9. `test_tam_handoff_request_serialization` -- Create TAMHandoffRequest, serialize to JSON, deserialize back, verify all fields preserved.

10. `test_tam_trigger_does_not_match_other_agent_keywords` -- Verify TAM keywords don't overlap excessively with BA or SA keywords. Test that "we need requirements" does NOT trigger TAM (it should trigger BA instead).

**Agent fixtures:**
- `sales_agent` fixture: SalesAgent with mock LLM (follow pattern from test_ba_handoff.py)
- `tam_agent` fixture: TAMAgent with mock LLM, real HealthScorer, mock services

All tests use `@pytest.mark.asyncio`. Mock LLM returns pre-built JSON strings. Use real HealthScorer in round-trip tests.
  </action>
  <verify>
Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -m pytest tests/test_tam_handoff.py -v --timeout=30 2>&1 | tail -20` -- all tests must pass.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -m pytest tests/test_tam_handoff.py --co -q 2>&1` -- must list at least 10 tests.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -m pytest tests/ -x -q --timeout=30 2>&1 | tail -5` -- full test suite passes.
  </verify>
  <done>
10+ round-trip handoff tests pass covering Sales->TAM dispatch (keyword triggers, stage triggers, missing fields, request-type mapping, default type), full round-trip flows proving end-to-end handoff works for health scan and escalation outreach, and keyword isolation from other agent triggers.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_tam_handoff.py -v` -- all 10+ tests pass
2. `python -m pytest tests/ -x -q --timeout=30` -- full test suite passes
3. Sales Agent has dispatch_tam_health_check + _is_tam_trigger
4. No circular imports between Sales/TAM agent modules
5. `grep 'TAM_REQUEST_TO_TASK_TYPE' src/app/agents/sales/agent.py` -- explicit dict exists
</verification>

<success_criteria>
- Sales Agent dispatches to TAM on 2+ keyword matches or post-sale stage threshold
- Dispatch uses lazy import pattern (no circular deps)
- TAM_REQUEST_TO_TASK_TYPE dict correctly maps all 6 request types to TAM task router keys
- Round-trip tests prove Sales->TAM health scan and escalation outreach flows work
- TAM trigger keywords are distinct from BA/SA/PM keywords (no unintended cross-triggering)
- Full existing test suite still passes
</success_criteria>

<output>
After completion, create `.planning/phases/13-technical-account-manager-agent/13-05-SUMMARY.md`
</output>
