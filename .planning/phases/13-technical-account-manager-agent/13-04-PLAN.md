---
phase: 13-technical-account-manager-agent
plan: 04
type: execute
wave: 3
depends_on: ["13-02", "13-03"]
files_modified:
  - src/app/main.py
  - tests/test_technical_account_manager.py
autonomous: true

must_haves:
  truths:
    - "TAM agent initializes during app startup and registers in AgentRegistry"
    - "TAMScheduler starts during app startup and runs daily health scans"
    - "All 7 TAM capability handlers return correct structured output"
    - "Health scan computes score without LLM and triggers escalation when appropriate"
    - "Unknown task type raises ValueError"
    - "LLM failure triggers fail-open response"
    - "HealthScorer is fully tested for all threshold combinations"
    - "GmailService.create_draft produces correct output structure"
  artifacts:
    - path: "src/app/main.py"
      provides: "TAM agent wiring in lifespan (Phase 13 block) including TAMScheduler start"
      contains: "technical_account_manager"
    - path: "tests/test_technical_account_manager.py"
      provides: "Integration tests covering all 7 handlers + HealthScorer + error cases + registration + create_draft"
      min_lines: 300
  key_links:
    - from: "src/app/main.py"
      to: "src/app/agents/technical_account_manager"
      via: "import and instantiate TAMAgent in lifespan"
      pattern: "from src.app.agents.technical_account_manager import"
    - from: "src/app/main.py"
      to: "app.state.technical_account_manager"
      via: "state assignment for runtime access"
      pattern: "app\\.state\\.technical_account_manager"
    - from: "src/app/main.py"
      to: "src/app/agents/technical_account_manager/scheduler.py"
      via: "import TAMScheduler, instantiate and start in lifespan"
      pattern: "TAMScheduler"
    - from: "tests/test_technical_account_manager.py"
      to: "src/app/agents/technical_account_manager"
      via: "import agent + schemas + health_scorer for test assertions"
      pattern: "from src.app.agents.technical_account_manager"
---

<objective>
Wire the TAM agent into the application lifespan (including TAMScheduler startup for daily background scans) and create comprehensive integration tests covering all 7 handlers, HealthScorer edge cases, GmailService.create_draft, error handling, and registration.

Purpose: Makes the TAM agent live in the application with its scheduled background health scans running, and proves all handlers, the health scorer, and the Gmail draft capability work correctly with mocked external dependencies.
Output: main.py updated with TAM initialization block + scheduler start, test_technical_account_manager.py with full test coverage
</objective>

<execution_context>
@/Users/RAZER/.claude/get-shit-done/workflows/execute-plan.md
@/Users/RAZER/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-technical-account-manager-agent/13-CONTEXT.md
@.planning/phases/13-technical-account-manager-agent/13-RESEARCH.md

# Pattern references
@src/app/main.py
@tests/test_business_analyst.py
@tests/test_project_manager.py

# Scheduler pattern to clone
@src/app/agents/project_manager/scheduler.py

# Dependencies from plans 01-03
@src/app/agents/technical_account_manager/schemas.py
@src/app/agents/technical_account_manager/agent.py
@src/app/agents/technical_account_manager/capabilities.py
@src/app/agents/technical_account_manager/health_scorer.py
@src/app/agents/technical_account_manager/ticket_client.py
@src/app/agents/technical_account_manager/notion_tam.py
@src/app/agents/technical_account_manager/scheduler.py
@src/app/services/gsuite/gmail.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire TAM agent and TAMScheduler into main.py lifespan</name>
  <files>src/app/main.py</files>
  <action>
Add a Phase 13 TAM agent initialization block in `main.py` lifespan, following the exact same pattern as Phase 10 (SA), Phase 11 (PM), and Phase 12 (BA). Place it AFTER the Phase 12 BA block and BEFORE the Phase 5 Deal Management block.

```python
    # -- Phase 13: Technical Account Manager Agent ----------------------------
    # Health monitoring and escalation prediction agent. Follows SA/PM/BA
    # pattern: instantiate with shared services, register in AgentRegistry.
    # TAM additionally needs gmail_service (for create_draft), chat_service,
    # health_scorer, and optionally ticket_client + notion_tam.
    # Includes TAMScheduler for daily health scans (APScheduler, same as PM).
    # Fail-tolerant -- TAM unavailability does not prevent app startup.

    try:
        from src.app.agents.technical_account_manager import (
            TAMAgent,
            create_tam_registration,
        )
        from src.app.agents.technical_account_manager.health_scorer import HealthScorer
        from src.app.agents.technical_account_manager.scheduler import TAMScheduler

        tam_registration = create_tam_registration()
        health_scorer = HealthScorer()

        tam_agent = TAMAgent(
            registration=tam_registration,
            llm_service=getattr(app.state, "llm_service", None)
            or locals().get("llm_service"),
            gmail_service=getattr(app.state, "gmail_service", None)
            or locals().get("gmail_service"),
            chat_service=getattr(app.state, "chat_service", None)
            or locals().get("chat_service"),
            event_bus=getattr(app.state, "event_bus", None)
            or locals().get("event_bus"),
            health_scorer=health_scorer,
        )

        # Register in agent registry
        agent_registry = getattr(app.state, "agent_registry", None)
        if agent_registry is not None:
            agent_registry.register(tam_registration)
            tam_registration._agent_instance = tam_agent
        app.state.technical_account_manager = tam_agent

        # Start TAMScheduler for daily health scans + monthly check-ins
        # Mirrors PMScheduler pattern: instantiate, start, store on app.state
        tam_scheduler = TAMScheduler(
            tam_agent=tam_agent,
            notion_tam=getattr(tam_agent, "_notion_tam", None),
        )
        tam_scheduler_started = tam_scheduler.start()
        if tam_scheduler_started:
            app.state.tam_scheduler = tam_scheduler
            log.info("phase13.tam_scheduler_started")
        else:
            log.warning("phase13.tam_scheduler_not_started", reason="APScheduler unavailable or start failed")

        log.info("phase13.technical_account_manager_initialized")
    except Exception as exc:
        log.warning("phase13.technical_account_manager_init_failed", error=str(exc))
```

Also add TAMScheduler cleanup in the shutdown section (near the existing Phase 4.1 and Phase 7 scheduler cleanup):

```python
    # Clean up Phase 13 TAM scheduler
    tam_scheduler_ref = getattr(app.state, "tam_scheduler", None)
    if tam_scheduler_ref:
        tam_scheduler_ref.stop()
```

Key details:
- Same try/except pattern as SA/PM/BA: import inside try, create registration, instantiate agent with shared services, register in agent_registry, store on app.state
- TAM constructor receives more services than BA: gmail_service, chat_service, event_bus, health_scorer
- TAMScheduler is instantiated AFTER tam_agent, started via .start(), and stored on app.state for shutdown cleanup
- No notion_tam or ticket_client in initial wiring (configured separately when Notion databases are set up, same pattern as PM/BA)
- Fail-tolerant: logs warning but does not prevent startup
  </action>
  <verify>
Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -c "
import ast
with open('src/app/main.py') as f:
    tree = ast.parse(f.read())
print('main.py parses OK')
"` -- must succeed.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && grep -n 'phase13.technical_account_manager' src/app/main.py` -- must find the log line.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && grep -n 'app.state.technical_account_manager' src/app/main.py` -- must find the state assignment.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && grep -n 'TAMScheduler' src/app/main.py` -- must find TAMScheduler import and instantiation.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && grep -n 'tam_scheduler.start()' src/app/main.py` -- must find the scheduler start call.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && grep -n 'tam_scheduler_ref.stop()' src/app/main.py` -- must find the shutdown cleanup.
  </verify>
  <done>
TAM agent initialization block added to main.py lifespan, positioned after BA and before Deal Management. Follows identical pattern to SA/PM/BA wiring. app.state.technical_account_manager is set. TAMScheduler is instantiated, started, and stored on app.state for daily health scans. Shutdown cleanup stops the scheduler.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive integration tests</name>
  <files>tests/test_technical_account_manager.py</files>
  <action>
Create `tests/test_technical_account_manager.py` following test_business_analyst.py and test_project_manager.py patterns. All external dependencies (LLM, Notion, Gmail, Chat, event bus) are mocked.

**Test setup:**
```python
import json
from unittest.mock import AsyncMock, MagicMock, patch
import pytest
from src.app.agents.technical_account_manager import (
    TAMAgent, create_tam_registration,
)
from src.app.agents.technical_account_manager.schemas import (
    HealthScoreResult, RelationshipProfile, TAMResult, TAMTask,
    TicketSummary, StakeholderProfile, IntegrationStatus,
    CommunicationRecord, EscalationNotificationResult,
    TAMHandoffRequest, TAMHandoffResponse, CoDevOpportunity,
)
from src.app.agents.technical_account_manager.health_scorer import HealthScorer
```

**Mock response factory functions:**

1. `_make_escalation_outreach_json() -> str` -- Returns JSON with subject, body_html, tone, key_issues fields
2. `_make_release_notes_json() -> str` -- Returns JSON with subject, body_html, highlighted_features, relevance_notes
3. `_make_roadmap_preview_json() -> str` -- Returns JSON with subject, body_html, aligned_items, co_dev_opportunities list
4. `_make_health_checkin_json() -> str` -- Returns JSON with subject, body_html, health_summary, recommendations
5. `_make_customer_success_review_json() -> str` -- Returns JSON with subject, body_html, health_overview, integration_summary, open_items, recommendations

**Agent fixture:**
```python
@pytest.fixture
def tam_agent():
    registration = create_tam_registration()
    mock_llm = AsyncMock()
    mock_notion_tam = AsyncMock()
    mock_gmail = AsyncMock()
    mock_chat = AsyncMock()
    mock_event_bus = AsyncMock()
    mock_ticket_client = AsyncMock()
    health_scorer = HealthScorer()  # Use REAL health scorer (no mock -- it's pure Python)

    agent = TAMAgent(
        registration=registration,
        llm_service=mock_llm,
        notion_tam=mock_notion_tam,
        gmail_service=mock_gmail,
        chat_service=mock_chat,
        event_bus=mock_event_bus,
        ticket_client=mock_ticket_client,
        health_scorer=health_scorer,
    )
    return agent, mock_llm, mock_notion_tam, mock_gmail, mock_chat, mock_event_bus, mock_ticket_client
```

**Tests (minimum 20):**

**Registration tests (2):**
1. `test_registration_correctness` -- create_tam_registration returns agent_id="technical_account_manager", 5 capabilities
2. `test_tam_is_base_agent_subclass` -- Verify TAMAgent inherits from BaseAgent

**HealthScorer tests (6):**
3. `test_health_scorer_perfect_health` -- No issues -> score=100, rag="Green"
4. `test_health_scorer_p1_p2_penalty` -- 2 aged P1/P2 tickets -> score=60
5. `test_health_scorer_excess_ticket_penalty` -- 8 open tickets (3 excess) -> score=85
6. `test_health_scorer_heartbeat_silence_penalty` -- silence > 2x threshold -> score=70
7. `test_health_scorer_none_heartbeat_no_penalty` -- None heartbeat -> score=100
8. `test_health_scorer_combined_penalties` -- All 3 signals bad -> score floors at 0
9. `test_health_scorer_should_escalate` -- Test all 3 escalation conditions: score<40, Green->Amber, non-Red->Red
10. `test_health_scorer_custom_thresholds` -- HealthScorer with custom thresholds works

**Handler tests (7):**
11. `test_health_scan_single_account` -- Mock ticket_client returns tickets, health_scorer computes. Assert TAMResult has health_score.
12. `test_escalation_outreach_handler` -- Mock LLM returns escalation JSON. Assert create_draft called (NOT send_email). Assert TAMResult has communication_content and draft_id.
13. `test_release_notes_handler` -- Mock LLM returns release notes JSON. Assert create_draft called. Assert result has communication_type="release_notes".
14. `test_roadmap_preview_handler` -- Mock LLM returns roadmap JSON with co-dev opportunities. Assert event_bus.publish called for opportunity dispatch.
15. `test_health_checkin_handler` -- Mock LLM returns checkin JSON. Assert create_draft called.
16. `test_customer_success_review_handler` -- Mock LLM returns CSR JSON. Assert create_draft called.
17. `test_update_relationship_profile_handler` -- Mock notion_tam. Assert profile update writes to Notion.

**Error handling tests (3):**
18. `test_unknown_task_type_raises_value_error` -- Call with type="nonexistent". Assert ValueError raised (not error dict -- TAM follows PM pattern, not BA).
19. `test_llm_failure_fail_open` -- Mock LLM to raise Exception. Assert error dict returned (not exception raised).
20. `test_escalation_notification_partial_failure` -- Mock one channel (e.g., chat_service) to raise. Assert other channels still fire. Assert EscalationNotificationResult shows channel-level success/failure.

**Schema tests (2):**
21. `test_health_score_result_auto_escalate` -- HealthScoreResult with score=35 auto-sets should_escalate=True. Score=85 auto-sets False.
22. `test_handoff_payload_construction` -- Create TAMHandoffRequest and TAMHandoffResponse, verify serialize/deserialize correctly.

All tests use `@pytest.mark.asyncio` where needed. Use the REAL HealthScorer (not mocked) since it's pure Python and deterministic.
  </action>
  <verify>
Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -m pytest tests/test_technical_account_manager.py -v --timeout=30 2>&1 | tail -30` -- all tests must pass.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -m pytest tests/test_technical_account_manager.py --co -q 2>&1` -- must list at least 20 tests.

Run: `cd "/Users/RAZER/Documents/projects/sales army" && python -m pytest tests/ -x -q --timeout=30 2>&1 | tail -5` -- full test suite passes.
  </verify>
  <done>
20+ integration tests pass covering all 7 handlers, HealthScorer edge cases (6 tests), error handling (unknown type, LLM failure, partial notification failure), schema validation, and registration. Real HealthScorer used (no mock) for deterministic testing.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_technical_account_manager.py -v` -- all tests pass
2. `grep 'phase13.technical_account_manager' src/app/main.py` -- wiring exists
3. `grep 'app.state.technical_account_manager' src/app/main.py` -- state assignment exists
4. `grep 'TAMScheduler' src/app/main.py` -- scheduler import and instantiation exists
5. `grep 'tam_scheduler.start' src/app/main.py` -- scheduler started
6. `grep 'tam_scheduler_ref.stop' src/app/main.py` -- shutdown cleanup exists
7. `python -m pytest tests/ -x -q --timeout=30 2>&1 | tail -5` -- full test suite passes
</verification>

<success_criteria>
- TAM agent initializes in main.py lifespan (fail-tolerant)
- app.state.technical_account_manager is set during startup
- TAMScheduler is instantiated, started, and stored on app.state for daily health scans
- TAMScheduler shutdown cleanup exists in the shutdown section
- 20+ integration tests pass covering all handlers, HealthScorer, error paths, and edge cases
- HealthScorer tests use real implementation (deterministic, no mocking needed)
- Full existing test suite still passes
</success_criteria>

<output>
After completion, create `.planning/phases/13-technical-account-manager-agent/13-04-SUMMARY.md`
</output>
